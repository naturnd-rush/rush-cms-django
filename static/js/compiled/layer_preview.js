import{a as Ye,g as ze}from"./graphql.js";import{l as P,c as Ke,g as Ze,a as Qe,i as fe,b as Pe}from"./utils/math.js";import{w as ie,T as et,a as $,e as _e}from"./utils/timing.js";import{D as tt}from"./utils/events.js";var I="INUMBER",Y="IOP1",z="IOP2",K="IOP3",D="IVAR",B="IVARNAME",H="IFUNCALL",oe="IFUNDEF",_="IEXPR",Ee="IEXPREVAL",G="IMEMBER",ae="IENDSTATEMENT",W="IARRAY";function g(e,t){this.type=e,this.value=t??0}g.prototype.toString=function(){switch(this.type){case I:case Y:case z:case K:case D:case B:case ae:return this.value;case H:return"CALL "+this.value;case oe:return"DEF "+this.value;case W:return"ARRAY "+this.value;case G:return"."+this.value;default:return"Invalid Instruction"}};function pe(e){return new g(Y,e)}function F(e){return new g(z,e)}function Ge(e){return new g(K,e)}function we(e,t,r,n,s){for(var o=[],i=[],a,p,u,h,c=0;c<e.length;c++){var l=e[c],f=l.type;if(f===I||f===B)Array.isArray(l.value)?o.push.apply(o,we(l.value.map(function(m){return new g(I,m)}).concat(new g(W,l.value.length)),t,r,n,s)):o.push(l);else if(f===D&&s.hasOwnProperty(l.value))l=new g(I,s[l.value]),o.push(l);else if(f===z&&o.length>1)p=o.pop(),a=o.pop(),h=r[l.value],l=new g(I,h(a.value,p.value)),o.push(l);else if(f===K&&o.length>2)u=o.pop(),p=o.pop(),a=o.pop(),l.value==="?"?o.push(a.value?p.value:u.value):(h=n[l.value],l=new g(I,h(a.value,p.value,u.value)),o.push(l));else if(f===Y&&o.length>0)a=o.pop(),h=t[l.value],l=new g(I,h(a.value)),o.push(l);else if(f===_){for(;o.length>0;)i.push(o.shift());i.push(new g(_,we(l.value,t,r,n,s)))}else if(f===G&&o.length>0)a=o.pop(),o.push(new g(I,a.value[l.value]));else{for(;o.length>0;)i.push(o.shift());i.push(l)}}for(;o.length>0;)i.push(o.shift());return i}function Je(e,t,r){for(var n=[],s=0;s<e.length;s++){var o=e[s],i=o.type;if(i===D&&o.value===t)for(var a=0;a<r.tokens.length;a++){var p=r.tokens[a],u;p.type===Y?u=pe(p.value):p.type===z?u=F(p.value):p.type===K?u=Ge(p.value):u=new g(p.type,p.value),n.push(u)}else i===_?n.push(new g(_,Je(o.value,t,r))):n.push(o)}return n}function q(e,t,r){var n=[],s,o,i,a,p,u;if(Oe(e))return R(e,r);for(var h=e.length,c=0;c<h;c++){var l=e[c],f=l.type;if(f===I||f===B)n.push(l.value);else if(f===z)o=n.pop(),s=n.pop(),l.value==="and"?n.push(s?!!q(o,t,r):!1):l.value==="or"?n.push(s?!0:!!q(o,t,r)):l.value==="="?(a=t.binaryOps[l.value],n.push(a(s,q(o,t,r),r))):(a=t.binaryOps[l.value],n.push(a(R(s,r),R(o,r))));else if(f===K)i=n.pop(),o=n.pop(),s=n.pop(),l.value==="?"?n.push(q(s?o:i,t,r)):(a=t.ternaryOps[l.value],n.push(a(R(s,r),R(o,r),R(i,r))));else if(f===D)if(l.value in t.functions)n.push(t.functions[l.value]);else if(l.value in t.unaryOps&&t.parser.isOperatorEnabled(l.value))n.push(t.unaryOps[l.value]);else{var m=r[l.value];if(m!==void 0)n.push(m);else throw new Error("undefined variable: "+l.value)}else if(f===Y)s=n.pop(),a=t.unaryOps[l.value],n.push(a(R(s,r)));else if(f===H){for(u=l.value,p=[];u-- >0;)p.unshift(R(n.pop(),r));if(a=n.pop(),a.apply&&a.call)n.push(a.apply(void 0,p));else throw new Error(a+" is not a function")}else if(f===oe)n.push(function(){for(var y=n.pop(),O=[],d=l.value;d-- >0;)O.unshift(n.pop());var k=n.pop(),v=function(){for(var w=Object.assign({},r),b=0,x=O.length;b<x;b++)w[O[b]]=arguments[b];return q(y,t,w)};return Object.defineProperty(v,"name",{value:k,writable:!1}),r[k]=v,v}());else if(f===_)n.push(rt(l,t));else if(f===Ee)n.push(l);else if(f===G)s=n.pop(),n.push(s[l.value]);else if(f===ae)n.pop();else if(f===W){for(u=l.value,p=[];u-- >0;)p.unshift(n.pop());n.push(p)}else throw new Error("invalid Expression")}if(n.length>1)throw new Error("invalid Expression (parity)");return n[0]===0?0:R(n[0],r)}function rt(e,t,r){return Oe(e)?e:{type:Ee,value:function(n){return q(e.value,t,n)}}}function Oe(e){return e&&e.type===Ee}function R(e,t){return Oe(e)?e.value(t):e}function be(e,t){for(var r=[],n,s,o,i,a,p,u=0;u<e.length;u++){var h=e[u],c=h.type;if(c===I)typeof h.value=="number"&&h.value<0?r.push("("+h.value+")"):Array.isArray(h.value)?r.push("["+h.value.map(Le).join(", ")+"]"):r.push(Le(h.value));else if(c===z)s=r.pop(),n=r.pop(),i=h.value,t?i==="^"?r.push("Math.pow("+n+", "+s+")"):i==="and"?r.push("(!!"+n+" && !!"+s+")"):i==="or"?r.push("(!!"+n+" || !!"+s+")"):i==="||"?r.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+n+"),("+s+")))"):i==="=="?r.push("("+n+" === "+s+")"):i==="!="?r.push("("+n+" !== "+s+")"):i==="["?r.push(n+"[("+s+") | 0]"):r.push("("+n+" "+i+" "+s+")"):i==="["?r.push(n+"["+s+"]"):r.push("("+n+" "+i+" "+s+")");else if(c===K)if(o=r.pop(),s=r.pop(),n=r.pop(),i=h.value,i==="?")r.push("("+n+" ? "+s+" : "+o+")");else throw new Error("invalid Expression");else if(c===D||c===B)r.push(h.value);else if(c===Y)n=r.pop(),i=h.value,i==="-"||i==="+"?r.push("("+i+n+")"):t?i==="not"?r.push("(!"+n+")"):i==="!"?r.push("fac("+n+")"):r.push(i+"("+n+")"):i==="!"?r.push("("+n+"!)"):r.push("("+i+" "+n+")");else if(c===H){for(p=h.value,a=[];p-- >0;)a.unshift(r.pop());i=r.pop(),r.push(i+"("+a.join(", ")+")")}else if(c===oe){for(s=r.pop(),p=h.value,a=[];p-- >0;)a.unshift(r.pop());n=r.pop(),t?r.push("("+n+" = function("+a.join(", ")+") { return "+s+" })"):r.push("("+n+"("+a.join(", ")+") = "+s+")")}else if(c===G)n=r.pop(),r.push(n+"."+h.value);else if(c===W){for(p=h.value,a=[];p-- >0;)a.unshift(r.pop());r.push("["+a.join(", ")+"]")}else if(c===_)r.push("("+be(h.value,t)+")");else if(c!==ae)throw new Error("invalid Expression")}return r.length>1&&(t?r=[r.join(",")]:r=[r.join(";")]),String(r[0])}function Le(e){return typeof e=="string"?JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):e}function j(e,t){for(var r=0;r<e.length;r++)if(e[r]===t)return!0;return!1}function Me(e,t,r){r=r||{};for(var n=!!r.withMembers,s=null,o=0;o<e.length;o++){var i=e[o];i.type===D||i.type===B?!n&&!j(t,i.value)?t.push(i.value):(s!==null&&(j(t,s)||t.push(s)),s=i.value):i.type===G&&n&&s!==null?s+="."+i.value:i.type===_?Me(i.value,t,r):s!==null&&(j(t,s)||t.push(s),s=null)}s!==null&&!j(t,s)&&t.push(s)}function C(e,t){this.tokens=e,this.parser=t,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.functions=t.functions}C.prototype.simplify=function(e){return e=e||{},new C(we(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,e),this.parser)};C.prototype.substitute=function(e,t){return t instanceof C||(t=this.parser.parse(String(t))),new C(Je(this.tokens,e,t),this.parser)};C.prototype.evaluate=function(e){return e=e||{},q(this.tokens,this,e)};C.prototype.toString=function(){return be(this.tokens,!1)};C.prototype.symbols=function(e){e=e||{};var t=[];return Me(this.tokens,t,e),t};C.prototype.variables=function(e){e=e||{};var t=[];Me(this.tokens,t,e);var r=this.functions;return t.filter(function(n){return!(n in r)})};C.prototype.toJSFunction=function(e,t){var r=this,n=new Function(e,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+be(this.simplify(t).tokens,!0)+"; }");return function(){return n.apply(r,arguments)}};var re="TEOF",E="TOP",ue="TNUMBER",je="TSTRING",U="TPAREN",X="TBRACKET",le="TCOMMA",me="TNAME",ke="TSEMICOLON";function $e(e,t,r){this.type=e,this.value=t,this.index=r}$e.prototype.toString=function(){return this.type+": "+this.value};function A(e,t){this.pos=0,this.current=null,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.consts=e.consts,this.expression=t,this.savedPosition=0,this.savedCurrent=null,this.options=e.options,this.parser=e}A.prototype.newToken=function(e,t,r){return new $e(e,t,r??this.pos)};A.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};A.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};A.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(re,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};A.prototype.isString=function(){var e=!1,t=this.pos,r=this.expression.charAt(t);if(r==="'"||r==='"')for(var n=this.expression.indexOf(r,t+1);n>=0&&this.pos<this.expression.length;){if(this.pos=n+1,this.expression.charAt(n-1)!=="\\"){var s=this.expression.substring(t+1,n);this.current=this.newToken(je,this.unescape(s),t),e=!0;break}n=this.expression.indexOf(r,n+1)}return e};A.prototype.isParen=function(){var e=this.expression.charAt(this.pos);return e==="("||e===")"?(this.current=this.newToken(U,e),this.pos++,!0):!1};A.prototype.isBracket=function(){var e=this.expression.charAt(this.pos);return(e==="["||e==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(X,e),this.pos++,!0):!1};A.prototype.isComma=function(){var e=this.expression.charAt(this.pos);return e===","?(this.current=this.newToken(le,","),this.pos++,!0):!1};A.prototype.isSemicolon=function(){var e=this.expression.charAt(this.pos);return e===";"?(this.current=this.newToken(ke,";"),this.pos++,!0):!1};A.prototype.isConst=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var r=this.expression.charAt(t);if(r.toUpperCase()===r.toLowerCase()&&(t===this.pos||r!=="_"&&r!=="."&&(r<"0"||r>"9")))break}if(t>e){var n=this.expression.substring(e,t);if(n in this.consts)return this.current=this.newToken(ue,this.consts[n]),this.pos+=n.length,!0}return!1};A.prototype.isNamedOp=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var r=this.expression.charAt(t);if(r.toUpperCase()===r.toLowerCase()&&(t===this.pos||r!=="_"&&(r<"0"||r>"9")))break}if(t>e){var n=this.expression.substring(e,t);if(this.isOperatorEnabled(n)&&(n in this.binaryOps||n in this.unaryOps||n in this.ternaryOps))return this.current=this.newToken(E,n),this.pos+=n.length,!0}return!1};A.prototype.isName=function(){for(var e=this.pos,t=e,r=!1;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()){if(t===this.pos&&(n==="$"||n==="_")){n==="_"&&(r=!0);continue}else if(t===this.pos||!r||n!=="_"&&(n<"0"||n>"9"))break}else r=!0}if(r){var s=this.expression.substring(e,t);return this.current=this.newToken(me,s),this.pos+=s.length,!0}return!1};A.prototype.isWhitespace=function(){for(var e=!1,t=this.expression.charAt(this.pos);(t===" "||t==="	"||t===`
`||t==="\r")&&(e=!0,this.pos++,!(this.pos>=this.expression.length));)t=this.expression.charAt(this.pos);return e};var nt=/^[0-9a-f]{4}$/i;A.prototype.unescape=function(e){var t=e.indexOf("\\");if(t<0)return e;for(var r=e.substring(0,t);t>=0;){var n=e.charAt(++t);switch(n){case"'":r+="'";break;case'"':r+='"';break;case"\\":r+="\\";break;case"/":r+="/";break;case"b":r+="\b";break;case"f":r+="\f";break;case"n":r+=`
`;break;case"r":r+="\r";break;case"t":r+="	";break;case"u":var s=e.substring(t+1,t+5);nt.test(s)||this.parseError("Illegal escape sequence: \\u"+s),r+=String.fromCharCode(parseInt(s,16)),t+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+n+'"')}++t;var o=e.indexOf("\\",t);r+=e.substring(t,o<0?e.length:o),t=o}return r};A.prototype.isComment=function(){var e=this.expression.charAt(this.pos);return e==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};A.prototype.isRadixInteger=function(){var e=this.pos;if(e>=this.expression.length-2||this.expression.charAt(e)!=="0")return!1;++e;var t,r;if(this.expression.charAt(e)==="x")t=16,r=/^[0-9a-f]$/i,++e;else if(this.expression.charAt(e)==="b")t=2,r=/^[01]$/i,++e;else return!1;for(var n=!1,s=e;e<this.expression.length;){var o=this.expression.charAt(e);if(r.test(o))e++,n=!0;else break}return n&&(this.current=this.newToken(ue,parseInt(this.expression.substring(s,e),t)),this.pos=e),n};A.prototype.isNumber=function(){for(var e=!1,t=this.pos,r=t,n=t,s=!1,o=!1,i;t<this.expression.length&&(i=this.expression.charAt(t),i>="0"&&i<="9"||!s&&i===".");)i==="."?s=!0:o=!0,t++,e=o;if(e&&(n=t),i==="e"||i==="E"){t++;for(var a=!0,p=!1;t<this.expression.length;){if(i=this.expression.charAt(t),a&&(i==="+"||i==="-"))a=!1;else if(i>="0"&&i<="9")p=!0,a=!1;else break;t++}p||(t=n)}return e?(this.current=this.newToken(ue,parseFloat(this.expression.substring(r,t))),this.pos=t):this.pos=n,e};A.prototype.isOperator=function(){var e=this.pos,t=this.expression.charAt(this.pos);if(t==="+"||t==="-"||t==="*"||t==="/"||t==="%"||t==="^"||t==="?"||t===":"||t===".")this.current=this.newToken(E,t);else if(t==="∙"||t==="•")this.current=this.newToken(E,"*");else if(t===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(E,">="),this.pos++):this.current=this.newToken(E,">");else if(t==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(E,"<="),this.pos++):this.current=this.newToken(E,"<");else if(t==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(E,"||"),this.pos++;else return!1;else if(t==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(E,"=="),this.pos++):this.current=this.newToken(E,t);else if(t==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(E,"!="),this.pos++):this.current=this.newToken(E,t);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=e,!1)};A.prototype.isOperatorEnabled=function(e){return this.parser.isOperatorEnabled(e)};A.prototype.getCoordinates=function(){var e=0,t,r=-1;do e++,t=this.pos-r,r=this.expression.indexOf(`
`,r+1);while(r>=0&&r<this.pos);return{line:e,column:t}};A.prototype.parseError=function(e){var t=this.getCoordinates();throw new Error("parse error ["+t.line+":"+t.column+"]: "+e)};function M(e,t,r){this.parser=e,this.tokens=t,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=r.allowMemberAccess!==!1}M.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};M.prototype.tokenMatches=function(e,t){return typeof t>"u"?!0:Array.isArray(t)?j(t,e.value):typeof t=="function"?t(e):e.value===t};M.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};M.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};M.prototype.accept=function(e,t){return this.nextToken.type===e&&this.tokenMatches(this.nextToken,t)?(this.next(),!0):!1};M.prototype.expect=function(e,t){if(!this.accept(e,t)){var r=this.tokens.getCoordinates();throw new Error("parse error ["+r.line+":"+r.column+"]: Expected "+(t||e))}};M.prototype.parseAtom=function(e){var t=this.tokens.unaryOps;function r(s){return s.value in t}if(this.accept(me)||this.accept(E,r))e.push(new g(D,this.current.value));else if(this.accept(ue))e.push(new g(I,this.current.value));else if(this.accept(je))e.push(new g(I,this.current.value));else if(this.accept(U,"("))this.parseExpression(e),this.expect(U,")");else if(this.accept(X,"["))if(this.accept(X,"]"))e.push(new g(W,0));else{var n=this.parseArrayList(e);e.push(new g(W,n))}else throw new Error("unexpected "+this.nextToken)};M.prototype.parseExpression=function(e){var t=[];this.parseUntilEndStatement(e,t)||(this.parseVariableAssignmentExpression(t),!this.parseUntilEndStatement(e,t)&&this.pushExpression(e,t))};M.prototype.pushExpression=function(e,t){for(var r=0,n=t.length;r<n;r++)e.push(t[r])};M.prototype.parseUntilEndStatement=function(e,t){return this.accept(ke)?(this.nextToken&&this.nextToken.type!==re&&!(this.nextToken.type===U&&this.nextToken.value===")")&&t.push(new g(ae)),this.nextToken.type!==re&&this.parseExpression(t),e.push(new g(_,t)),!0):!1};M.prototype.parseArrayList=function(e){for(var t=0;!this.accept(X,"]");)for(this.parseExpression(e),++t;this.accept(le);)this.parseExpression(e),++t;return t};M.prototype.parseVariableAssignmentExpression=function(e){for(this.parseConditionalExpression(e);this.accept(E,"=");){var t=e.pop(),r=[],n=e.length-1;if(t.type===H){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var s=0,o=t.value+1;s<o;s++){var i=n-s;e[i].type===D&&(e[i]=new g(B,e[i].value))}this.parseVariableAssignmentExpression(r),e.push(new g(_,r)),e.push(new g(oe,t.value));continue}if(t.type!==D&&t.type!==G)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(r),e.push(new g(B,t.value)),e.push(new g(_,r)),e.push(F("="))}};M.prototype.parseConditionalExpression=function(e){for(this.parseOrExpression(e);this.accept(E,"?");){var t=[],r=[];this.parseConditionalExpression(t),this.expect(E,":"),this.parseConditionalExpression(r),e.push(new g(_,t)),e.push(new g(_,r)),e.push(Ge("?"))}};M.prototype.parseOrExpression=function(e){for(this.parseAndExpression(e);this.accept(E,"or");){var t=[];this.parseAndExpression(t),e.push(new g(_,t)),e.push(F("or"))}};M.prototype.parseAndExpression=function(e){for(this.parseComparison(e);this.accept(E,"and");){var t=[];this.parseComparison(t),e.push(new g(_,t)),e.push(F("and"))}};var st=["==","!=","<","<=",">=",">","in"];M.prototype.parseComparison=function(e){for(this.parseAddSub(e);this.accept(E,st);){var t=this.current;this.parseAddSub(e),e.push(F(t.value))}};var it=["+","-","||"];M.prototype.parseAddSub=function(e){for(this.parseTerm(e);this.accept(E,it);){var t=this.current;this.parseTerm(e),e.push(F(t.value))}};var ot=["*","/","%"];M.prototype.parseTerm=function(e){for(this.parseFactor(e);this.accept(E,ot);){var t=this.current;this.parseFactor(e),e.push(F(t.value))}};M.prototype.parseFactor=function(e){var t=this.tokens.unaryOps;function r(s){return s.value in t}if(this.save(),this.accept(E,r)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===U&&this.nextToken.value==="("){this.restore(),this.parseExponential(e);return}else if(this.nextToken.type===ke||this.nextToken.type===le||this.nextToken.type===re||this.nextToken.type===U&&this.nextToken.value===")"){this.restore(),this.parseAtom(e);return}}var n=this.current;this.parseFactor(e),e.push(pe(n.value))}else this.parseExponential(e)};M.prototype.parseExponential=function(e){for(this.parsePostfixExpression(e);this.accept(E,"^");)this.parseFactor(e),e.push(F("^"))};M.prototype.parsePostfixExpression=function(e){for(this.parseFunctionCall(e);this.accept(E,"!");)e.push(pe("!"))};M.prototype.parseFunctionCall=function(e){var t=this.tokens.unaryOps;function r(o){return o.value in t}if(this.accept(E,r)){var n=this.current;this.parseAtom(e),e.push(pe(n.value))}else for(this.parseMemberExpression(e);this.accept(U,"(");)if(this.accept(U,")"))e.push(new g(H,0));else{var s=this.parseArgumentList(e);e.push(new g(H,s))}};M.prototype.parseArgumentList=function(e){for(var t=0;!this.accept(U,")");)for(this.parseExpression(e),++t;this.accept(le);)this.parseExpression(e),++t;return t};M.prototype.parseMemberExpression=function(e){for(this.parseAtom(e);this.accept(E,".")||this.accept(X,"[");){var t=this.current;if(t.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(me),e.push(new g(G,this.current.value))}else if(t.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(e),this.expect(X,"]"),e.push(F("["))}else throw new Error("unexpected symbol: "+t.value)}};function at(e,t){return Number(e)+Number(t)}function pt(e,t){return e-t}function ut(e,t){return e*t}function lt(e,t){return e/t}function ht(e,t){return e%t}function ct(e,t){return Array.isArray(e)&&Array.isArray(t)?e.concat(t):""+e+t}function ft(e,t){return e===t}function dt(e,t){return e!==t}function yt(e,t){return e>t}function vt(e,t){return e<t}function gt(e,t){return e>=t}function wt(e,t){return e<=t}function Et(e,t){return!!(e&&t)}function Ot(e,t){return!!(e||t)}function bt(e,t){return j(t,e)}function Mt(e){return(Math.exp(e)-Math.exp(-e))/2}function mt(e){return(Math.exp(e)+Math.exp(-e))/2}function kt(e){return e===1/0?1:e===-1/0?-1:(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function At(e){return e===-1/0?e:Math.log(e+Math.sqrt(e*e+1))}function Tt(e){return Math.log(e+Math.sqrt(e*e-1))}function xt(e){return Math.log((1+e)/(1-e))/2}function Ie(e){return Math.log(e)*Math.LOG10E}function St(e){return-e}function Pt(e){return!e}function _t(e){return e<0?Math.ceil(e):Math.floor(e)}function Lt(e){return Math.random()*(e||1)}function Ce(e){return Ae(e+1)}function It(e){return isFinite(e)&&e===Math.round(e)}var Ct=4.7421875,de=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function Ae(e){var t,r;if(It(e)){if(e<=0)return isFinite(e)?1/0:NaN;if(e>171)return 1/0;for(var n=e-2,s=e-1;n>1;)s*=n,n--;return s===0&&(s=1),s}if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*Ae(1-e));if(e>=171.35)return 1/0;if(e>85){var o=e*e,i=o*e,a=i*e,p=a*e;return Math.sqrt(2*Math.PI/e)*Math.pow(e/Math.E,e)*(1+1/(12*e)+1/(288*o)-139/(51840*i)-571/(2488320*a)+163879/(209018880*p)+5246819/(75246796800*p*e))}--e,r=de[0];for(var u=1;u<de.length;++u)r+=de[u]/(e+u);return t=e+Ct+.5,Math.sqrt(2*Math.PI)*Math.pow(t,e+.5)*Math.exp(-t)*r}function Nt(e){return Array.isArray(e)?e.length:String(e).length}function Ne(){for(var e=0,t=0,r=0;r<arguments.length;r++){var n=Math.abs(arguments[r]),s;t<n?(s=t/n,e=e*s*s+1,t=n):n>0?(s=n/t,e+=s*s):e+=n}return t===1/0?1/0:t*Math.sqrt(e)}function Re(e,t,r){return e?t:r}function Rt(e,t){return typeof t>"u"||+t==0?Math.round(e):(e=+e,t=-+t,isNaN(e)||!(typeof t=="number"&&t%1===0)?NaN:(e=e.toString().split("e"),e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]+t:t))))}function Dt(e,t,r){return r&&(r[e]=t),t}function Ut(e,t){return e[t|0]}function Ft(e){return arguments.length===1&&Array.isArray(e)?Math.max.apply(Math,e):Math.max.apply(Math,arguments)}function qt(e){return arguments.length===1&&Array.isArray(e)?Math.min.apply(Math,e):Math.min.apply(Math,arguments)}function Bt(e,t){if(typeof e!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(t))throw new Error("Second argument to map is not an array");return t.map(function(r,n){return e(r,n)})}function Gt(e,t,r){if(typeof e!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(r))throw new Error("Second argument to fold is not an array");return r.reduce(function(n,s,o){return e(n,s,o)},t)}function Jt(e,t){if(typeof e!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(t))throw new Error("Second argument to filter is not an array");return t.filter(function(r,n){return e(r,n)})}function jt(e,t){if(!(Array.isArray(t)||typeof t=="string"))throw new Error("Second argument to indexOf is not a string or array");return t.indexOf(e)}function $t(e,t){if(!Array.isArray(t))throw new Error("Second argument to join is not an array");return t.join(e)}function Ht(e){return(e>0)-(e<0)||+e}var De=1/3;function Wt(e){return e<0?-Math.pow(-e,De):Math.pow(e,De)}function Xt(e){return Math.exp(e)-1}function Vt(e){return Math.log(1+e)}function Yt(e){return Math.log(e)/Math.LN2}function J(e){this.options=e||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||Mt,cosh:Math.cosh||mt,tanh:Math.tanh||kt,asinh:Math.asinh||At,acosh:Math.acosh||Tt,atanh:Math.atanh||xt,sqrt:Math.sqrt,cbrt:Math.cbrt||Wt,log:Math.log,log2:Math.log2||Yt,ln:Math.log,lg:Math.log10||Ie,log10:Math.log10||Ie,expm1:Math.expm1||Xt,log1p:Math.log1p||Vt,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||_t,"-":St,"+":Number,exp:Math.exp,not:Pt,length:Nt,"!":Ce,sign:Math.sign||Ht},this.binaryOps={"+":at,"-":pt,"*":ut,"/":lt,"%":ht,"^":Math.pow,"||":ct,"==":ft,"!=":dt,">":yt,"<":vt,">=":gt,"<=":wt,and:Et,or:Ot,in:bt,"=":Dt,"[":Ut},this.ternaryOps={"?":Re},this.functions={random:Lt,fac:Ce,min:qt,max:Ft,hypot:Math.hypot||Ne,pyt:Math.hypot||Ne,pow:Math.pow,atan2:Math.atan2,if:Re,gamma:Ae,roundTo:Rt,map:Bt,fold:Gt,filter:Jt,indexOf:jt,join:$t},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}J.prototype.parse=function(e){var t=[],r=new M(this,new A(this,e),{allowMemberAccess:this.options.allowMemberAccess});return r.parseExpression(t),r.expect(re,"EOF"),new C(t,this)};J.prototype.evaluate=function(e,t){return this.parse(e).evaluate(t)};var He=new J;J.parse=function(e){return He.parse(e)};J.evaluate=function(e,t){return He.parse(e).evaluate(t)};var Ue={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function zt(e){return Ue.hasOwnProperty(e)?Ue[e]:e}J.prototype.isOperatorEnabled=function(e){var t=zt(e),r=this.options.operators||{};return!(t in r)||!!r[t]};/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var Kt=Object.prototype.toString,Z=Array.isArray||function(t){return Kt.call(t)==="[object Array]"};function Te(e){return typeof e=="function"}function Zt(e){return Z(e)?"array":typeof e}function ye(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Fe(e,t){return e!=null&&typeof e=="object"&&t in e}function Qt(e,t){return e!=null&&typeof e!="object"&&e.hasOwnProperty&&e.hasOwnProperty(t)}var er=RegExp.prototype.test;function tr(e,t){return er.call(e,t)}var rr=/\S/;function nr(e){return!tr(rr,e)}var sr={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function ir(e){return String(e).replace(/[&<>"'`=\/]/g,function(r){return sr[r]})}var or=/\s*/,ar=/\s+/,qe=/\s*=/,pr=/\s*\}/,ur=/#|\^|\/|>|\{|&|=|!/;function lr(e,t){if(!e)return[];var r=!1,n=[],s=[],o=[],i=!1,a=!1,p="",u=0;function h(){if(i&&!a)for(;o.length;)delete s[o.pop()];else o=[];i=!1,a=!1}var c,l,f;function m(T){if(typeof T=="string"&&(T=T.split(ar,2)),!Z(T)||T.length!==2)throw new Error("Invalid tags: "+T);c=new RegExp(ye(T[0])+"\\s*"),l=new RegExp("\\s*"+ye(T[1])),f=new RegExp("\\s*"+ye("}"+T[1]))}m(t||L.tags);for(var y=new se(e),O,d,k,v,w,b;!y.eos();){if(O=y.pos,k=y.scanUntil(c),k)for(var x=0,N=k.length;x<N;++x)v=k.charAt(x),nr(v)?(o.push(s.length),p+=v):(a=!0,r=!0,p+=" "),s.push(["text",v,O,O+1]),O+=1,v===`
`&&(h(),p="",u=0,r=!1);if(!y.scan(c))break;if(i=!0,d=y.scan(ur)||"name",y.scan(or),d==="="?(k=y.scanUntil(qe),y.scan(qe),y.scanUntil(l)):d==="{"?(k=y.scanUntil(f),y.scan(pr),y.scanUntil(l),d="&"):k=y.scanUntil(l),!y.scan(l))throw new Error("Unclosed tag at "+y.pos);if(d==">"?w=[d,k,O,y.pos,p,u,r]:w=[d,k,O,y.pos],u++,s.push(w),d==="#"||d==="^")n.push(w);else if(d==="/"){if(b=n.pop(),!b)throw new Error('Unopened section "'+k+'" at '+O);if(b[1]!==k)throw new Error('Unclosed section "'+b[1]+'" at '+O)}else d==="name"||d==="{"||d==="&"?a=!0:d==="="&&m(k)}if(h(),b=n.pop(),b)throw new Error('Unclosed section "'+b[1]+'" at '+y.pos);return cr(hr(s))}function hr(e){for(var t=[],r,n,s=0,o=e.length;s<o;++s)r=e[s],r&&(r[0]==="text"&&n&&n[0]==="text"?(n[1]+=r[1],n[3]=r[3]):(t.push(r),n=r));return t}function cr(e){for(var t=[],r=t,n=[],s,o,i=0,a=e.length;i<a;++i)switch(s=e[i],s[0]){case"#":case"^":r.push(s),n.push(s),r=s[4]=[];break;case"/":o=n.pop(),o[5]=s[2],r=n.length>0?n[n.length-1][4]:t;break;default:r.push(s)}return t}function se(e){this.string=e,this.tail=e,this.pos=0}se.prototype.eos=function(){return this.tail===""};se.prototype.scan=function(t){var r=this.tail.match(t);if(!r||r.index!==0)return"";var n=r[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n};se.prototype.scanUntil=function(t){var r=this.tail.search(t),n;switch(r){case-1:n=this.tail,this.tail="";break;case 0:n="";break;default:n=this.tail.substring(0,r),this.tail=this.tail.substring(r)}return this.pos+=n.length,n};function V(e,t){this.view=e,this.cache={".":this.view},this.parent=t}V.prototype.push=function(t){return new V(t,this)};V.prototype.lookup=function(t){var r=this.cache,n;if(r.hasOwnProperty(t))n=r[t];else{for(var s=this,o,i,a,p=!1;s;){if(t.indexOf(".")>0)for(o=s.view,i=t.split("."),a=0;o!=null&&a<i.length;)a===i.length-1&&(p=Fe(o,i[a])||Qt(o,i[a])),o=o[i[a++]];else o=s.view[t],p=Fe(s.view,t);if(p){n=o;break}s=s.parent}r[t]=n}return Te(n)&&(n=n.call(this.view)),n};function S(){this.templateCache={_cache:{},set:function(t,r){this._cache[t]=r},get:function(t){return this._cache[t]},clear:function(){this._cache={}}}}S.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};S.prototype.parse=function(t,r){var n=this.templateCache,s=t+":"+(r||L.tags).join(":"),o=typeof n<"u",i=o?n.get(s):void 0;return i==null&&(i=lr(t,r),o&&n.set(s,i)),i};S.prototype.render=function(t,r,n,s){var o=this.getConfigTags(s),i=this.parse(t,o),a=r instanceof V?r:new V(r,void 0);return this.renderTokens(i,a,n,t,s)};S.prototype.renderTokens=function(t,r,n,s,o){for(var i="",a,p,u,h=0,c=t.length;h<c;++h)u=void 0,a=t[h],p=a[0],p==="#"?u=this.renderSection(a,r,n,s,o):p==="^"?u=this.renderInverted(a,r,n,s,o):p===">"?u=this.renderPartial(a,r,n,o):p==="&"?u=this.unescapedValue(a,r):p==="name"?u=this.escapedValue(a,r,o):p==="text"&&(u=this.rawValue(a)),u!==void 0&&(i+=u);return i};S.prototype.renderSection=function(t,r,n,s,o){var i=this,a="",p=r.lookup(t[1]);function u(l){return i.render(l,r,n,o)}if(p){if(Z(p))for(var h=0,c=p.length;h<c;++h)a+=this.renderTokens(t[4],r.push(p[h]),n,s,o);else if(typeof p=="object"||typeof p=="string"||typeof p=="number")a+=this.renderTokens(t[4],r.push(p),n,s,o);else if(Te(p)){if(typeof s!="string")throw new Error("Cannot use higher-order sections without the original template");p=p.call(r.view,s.slice(t[3],t[5]),u),p!=null&&(a+=p)}else a+=this.renderTokens(t[4],r,n,s,o);return a}};S.prototype.renderInverted=function(t,r,n,s,o){var i=r.lookup(t[1]);if(!i||Z(i)&&i.length===0)return this.renderTokens(t[4],r,n,s,o)};S.prototype.indentPartial=function(t,r,n){for(var s=r.replace(/[^ \t]/g,""),o=t.split(`
`),i=0;i<o.length;i++)o[i].length&&(i>0||!n)&&(o[i]=s+o[i]);return o.join(`
`)};S.prototype.renderPartial=function(t,r,n,s){if(n){var o=this.getConfigTags(s),i=Te(n)?n(t[1]):n[t[1]];if(i!=null){var a=t[6],p=t[5],u=t[4],h=i;p==0&&u&&(h=this.indentPartial(i,u,a));var c=this.parse(h,o);return this.renderTokens(c,r,n,h,s)}}};S.prototype.unescapedValue=function(t,r){var n=r.lookup(t[1]);if(n!=null)return n};S.prototype.escapedValue=function(t,r,n){var s=this.getConfigEscape(n)||L.escape,o=r.lookup(t[1]);if(o!=null)return typeof o=="number"&&s===L.escape?String(o):s(o)};S.prototype.rawValue=function(t){return t[1]};S.prototype.getConfigTags=function(t){return Z(t)?t:t&&typeof t=="object"?t.tags:void 0};S.prototype.getConfigEscape=function(t){if(t&&typeof t=="object"&&!Z(t))return t.escape};var L={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){ne.templateCache=e},get templateCache(){return ne.templateCache}},ne=new S;L.clearCache=function(){return ne.clearCache()};L.parse=function(t,r){return ne.parse(t,r)};L.render=function(t,r,n,s){if(typeof t!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+Zt(t)+'" was given as the first argument for mustache#render(template, view, partials)');return ne.render(t,r,n,s)};L.escape=ir;L.Scanner=se;L.Context=V;L.Writer=S;async function ve(){var t,r,n,s,o,i,a,p,u,h,c,l;const e=[];for(let f of document.querySelectorAll("[id^='stylesonlayer_set-']:not([id$='-group'])")){const m=(t=f.querySelector("select[id*='-style']"))==null?void 0:t.value,y=(r=f.querySelector("textarea[id*='feature_mapping']"))==null?void 0:r.value,O=(n=f.querySelector("textarea[id*='popup']"))==null?void 0:n.value,d=(s=f.querySelector("input[id*='-draw_popup']"))==null?void 0:s.checked,k=(o=f.querySelector("input[id*='-draw_tooltip']"))==null?void 0:o.checked,v=(i=f.querySelector("textarea[id*='label']"))==null?void 0:i.value,w=(a=f.querySelector("input[id*='offset_x']"))==null?void 0:a.value,b=(p=f.querySelector("input[id*='offset_y']"))==null?void 0:p.value,x=(u=f.querySelector("input[id*='opacity']"))==null?void 0:u.value,N=(h=f.querySelector("select[id*='direction']"))==null?void 0:h.value,T=(c=f.querySelector("input[id*='permanent']"))==null?void 0:c.checked,Q=(l=f.querySelector("input[id*='sticky']"))==null?void 0:l.checked;if(!(m&&y))continue;const he=await ze(m);if(he!==null&&y!==void 0&&O!==void 0&&d!==void 0&&k!==void 0&&v!==void 0&&w!==void 0&&b!==void 0&&x!==void 0&&N!==void 0&&T!==void 0&&Q!==void 0){const ce={label:v,offsetX:Number.parseFloat(w),offsetY:Number.parseFloat(b),opacity:Number.parseFloat(x),direction:N,permanent:T,sticky:Q},Se={style:he,feature_mapping:y,inlineRow:f,drawPopup:d,popupTemplate:O,drawTooltip:k,tooltip:ce};e.push(Se)}else{const ce={label:v,offsetX:w!==void 0?Number.parseFloat(w):Number.NaN,offsetY:b!==void 0?Number.parseFloat(b):Number.NaN,opacity:x!==void 0?Number.parseFloat(x):Number.NaN,direction:N,permanent:T,sticky:Q};console.warn("One or more expected values in a StyleOnLayer inline is missing: ",{style:he,feature_mapping:y,inlineRow:f,drawPopup:d,popupTemplate:O,drawTooltip:k,tooltip:ce})}}return{type:"Style",newStylesOnLayers:e}}async function te(e){let t=null;for(let r of e.childNodes)r instanceof HTMLOptionElement&&r.selected&&(t=r.value);return t===null||t===""?null:await Ye(t)}async function Be(e){const t={type:"MapData",newGeoJsonData:null},r=await te(e);if(r===null)return t;if(r.geojson===null)return t;const n=JSON.parse(r.geojson);return n.features===null||n.features===void 0?t:{type:"MapData",newGeoJsonData:n}}function xe(e,t){const r=new J;let n=[];for(let s of t){const o=s.inlineRow.querySelector("td[class*='feature_mapping']"),i=o==null?void 0:o.querySelector("div[id*='errors']");try{r.parse(s.feature_mapping).evaluate(Qe(e.properties))===!0&&(n.push({styleOnLayer:s,popupTemplate:s.popupTemplate}),i&&o&&o.removeChild(i))}catch(a){if(i&&o&&o.removeChild(i),o&&!(o!=null&&o.querySelector("div[id*='errors']"))){const p=document.createElement("div");p.textContent=String(a),p.id="errors",p.style="color:rgb(255, 0, 0);",o.insertBefore(p,o.children[0])}}}return n}function fr(){return{fill:!0,fillColor:"#4B3EFF",fillOpacity:.3,stroke:!0,weight:1,opacity:1,color:"#4B3EFF",dashArray:"1 10",dashOffset:"0",lineCap:"round",lineJoin:"round"}}function dr(e){return r=>{if(e.stylesOnLayer.length==0&&!e.isUpdating)return fr();let n=xe(r,e.stylesOnLayer),s=!1,o,i,a=!1,p,u,h,c="",l,f="round",m="round";for(let O of n){const d=O.styleOnLayer.style;d.drawFill===!0&&(s=!0),d.drawStroke===!0&&(a=!0),o=fe(o,d.fillOpacity),p=fe(p,d.strokeOpacity),h=fe(h,d.strokeWeight),i===void 0?i=d.fillColor:i=Pe(i,d.fillColor,.5),u===void 0?u=d.strokeColor:u=Pe(u,d.strokeColor,.5),d.strokeDashArray!==null&&(c=d.strokeDashArray),d.strokeDashOffset!==null&&(l=d.strokeDashOffset),m=d.strokeLineJoin,f=d.strokeLineCap}const y={fill:s,fillColor:i,fillOpacity:o,stroke:a,weight:h,opacity:p,color:u,dashArray:c,dashOffset:l,lineCap:f,lineJoin:m};return r.properties.__style=y,y}}function We(e,t){const r=t.markerSize,n=Math.sqrt(Math.pow(r/2,2)+Math.pow(r/2,2));return{html:`
            <div>
                <div style="
                    width: ${n*2}px;
                    height: ${n*2}px;
                    background-color: ${t.markerBackgroundColor};
                    opacity: ${t.markerBackgroundOpacity};
                    border-radius: 50%;
                    display: flex;
                    position: absolute;
                "></div>
                <img 
                    src="${e+t.markerIcon}"
                    style="
                        width: ${r}px; 
                        height: ${r}px;
                        opacity: ${t.markerIconOpacity};
                        position: relative;
                        top: ${n-r/2}px;
                        left: ${n-r/2}px;
                    "
                />
            </div>
        `,className:"",iconSize:[n*2,n*2],iconAnchor:[n,n]}}function yr(e,t){return(n,s)=>{let o=null;const i=xe(n,t.stylesOnLayer);for(let p of i){const u=p.styleOnLayer.style;if(u.drawMarker===!0){o=u;break}}if(o===null)return P.marker(s);const a=We(e,o);return n.properties.__pointDivIconStyleProps=a,P.marker(s,{icon:new P.DivIcon(a)})}}async function Xe(){const e=$(document.body,"input[name='_save']"),t=$(document.body,"input[name='_addanother']"),r=$(document.body,"input[name='_continue']");e.disabled=!0,t.disabled=!0,r.disabled=!0;const n=document.getElementById("map-preview"),s=document.getElementById("map-spinner");n!==null&&s!==null?(n.classList.add("blur"),s.classList.remove("hidden")):console.error("Couldn't find map-preview and map-spinner in the DOM!")}function Ve(){const e=$(document.body,"input[name='_save']"),t=$(document.body,"input[name='_addanother']"),r=$(document.body,"input[name='_continue']");e.disabled=!1,t.disabled=!1,r.disabled=!1;const n=document.getElementById("map-preview"),s=document.getElementById("map-spinner");n!==null&&s!==null?(n.classList.remove("blur"),s.classList.add("hidden")):console.error("Couldn't find map-preview and map-spinner in the DOM!")}function ge(e,t){setTimeout(()=>{t.isUpdating&&Xe()},e*1e3)}function vr(e,t){if(t===null)return{__hasPopup:!1,__popupHTML:null,__popupOptions:null};let r=!1;return t=t.replace(/<img(.*?)>/g,o=>(r=!0,o.replace("<img",'<img style="max-width:250px; height:auto;"'))),{__hasPopup:!0,__popupHTML:L.render(t,e.properties),__popupOptions:{maxWidth:250,minWidth:r?250:0}}}function gr(e){let t=null;for(let r of e)r.popupTemplate!==null&&r.popupTemplate!==""&&r.styleOnLayer.drawPopup===!0&&(t=r.popupTemplate);return t}function ee(e,t,r){if(t.currentLayer!==null&&e.removeLayer(t.currentLayer),t.centroidMarkers.clearLayers(),r.type==="MapData"){const a=r.newGeoJsonData;a===null?t.currentLayer=null:(t.currentLayer=P.geoJSON(a),e.fitBounds(t.currentLayer.getBounds()))}else r.type==="Style"&&(t.stylesOnLayer=r.newStylesOnLayers);if(t.currentLayer===null)return;const n=_e("injected-media-url").innerHTML,s=t.stylesOnLayer.filter(a=>a.style.drawMarker==!0).length>0,o=P.geoJSON(t.currentLayer.toGeoJSON(),{style:dr(t),pointToLayer:yr(n,t),onEachFeature:(a,p)=>{const u=xe(a,t.stylesOnLayer),h=gr(u),c=vr(a,h);c.__hasPopup===!0&&c.__popupHTML!==null&&c.__popupOptions!==null&&(p.bindPopup(c.__popupHTML,c.__popupOptions),a.properties={...a.properties,...c});let l=null;for(let m of u)if(m.styleOnLayer.drawTooltip===!0){l=m.styleOnLayer.tooltip;break}if(l!==null){const m=L.render(l.label,a.properties),y={offset:new P.Point(l.offsetX,l.offsetY),opacity:l.opacity,direction:l.direction,permanent:l.permanent,sticky:l.sticky,className:"leaflet-label"};p.bindTooltip(m,y),a.properties={...a.properties,__hasTooltip:!0,__tooltipHTML:m,__tooltipOptions:y}}else a.properties={...a.properties,__hasTooltip:!1};if(a.geometry.type==="MultiPolygon"&&s){const m=a,y=u.filter(O=>O.styleOnLayer.style.drawMarker==!0);if(y.length>0){const O=y[0].styleOnLayer.style;for(let d of m.geometry.coordinates){const k=d[0],v=[];for(let T of k)v.push(new P.Point(T[0],T[1]));const w=Ze(v),b=We(n,O),x={type:"Feature",geometry:{type:"Point",coordinates:[w.x,w.y]},properties:{__pointDivIconStyleProps:b,...c}},N=P.geoJSON(x,{pointToLayer:(T,Q)=>P.marker(Q,{icon:new P.DivIcon(b)})}).getLayers()[0];c.__hasPopup===!0&&c.__popupHTML!==null&&c.__popupOptions!==null&&N.bindPopup(c.__popupHTML,c.__popupOptions),N.addTo(t.centroidMarkers)}}}}});t.currentLayer=o,o.addTo(e),Ve(),t.isUpdating=!1;const i=_e("id_serialized_leaflet_json");i.value=wr(t)}function wr(e){var r;let t=new P.LayerGroup(e.centroidMarkers.getLayers());return(r=e.currentLayer)==null||r.addTo(t),JSON.stringify({featureCollection:t.toGeoJSON()})}const Er=e=>{const t=(i,a)=>Array.from(i.querySelectorAll('div[class*="form-row"]')).filter(h=>{var c;return(c=h.querySelector("label"))==null?void 0:c.textContent.includes(a)}),r=(i,a,p)=>{e.subscribeEventListener("input",i,u=>{if(u.target!==null&&u.target instanceof HTMLInputElement){const h=u.target.closest("div[id*='stylesonlayer_set-']");if(h===null||!(h instanceof HTMLElement))throw new Error("Could not find 'draw_tooltip' form-field parent row!");const c=t(h,a);p(u.target.closest("div[class*='form-row']"),c,u.target.checked)}}),document.querySelectorAll(i).forEach(u=>u.dispatchEvent(new Event("input",{bubbles:!0})))},n="#FFFFFF",s="#E2DBC4",o="#f6f6f6";r("input[id*='-draw_tooltip']","Tooltip",(i,a,p)=>{for(let u of a)p===!0?(u.style.display="block",u.style.setProperty("background-color",o),i==null||i.style.setProperty("background-color",s)):(u.style.display="none",u.style.setProperty("background-color",n),i==null||i.style.setProperty("background-color",n))}),r("input[id*='-draw_popup']","Popup",(i,a,p)=>{for(let u of a)p===!0?(u.style.display="block",u.style.setProperty("background-color",o),i==null||i.style.setProperty("background-color",s)):(u.style.display="none",u.style.setProperty("background-color",n),i==null||i.style.setProperty("background-color",n))})};document.addEventListener("DOMContentLoaded",()=>{(async()=>{var k;const e={minZoom:0,maxZoom:22,updateWhenIdle:!0,zIndex:0,attribution:'© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>'},t="rushadmin",r="clw2m6f9b018001obfxcc747g",n="pk.eyJ1IjoicnVzaGFkbWluIiwiYSI6ImNsdzJtYmRydzBuNDIyam5yZ2pwMG16cnUifQ.SkSSdHcrPq4u8HSitBvJcg",s="https://api.mapbox.com/styles/v1/",o=`${t}/${r}/tiles/256/{z}/{x}/{y}@2x`,i=`?access_token=${n}`;let a=P.map("map-preview").setView([0,0],2);P.tileLayer(s+o+i,e).addTo(a);let p={isUpdating:!0,stylesOnLayer:[],currentLayer:null,centroidMarkers:new P.LayerGroup};p.centroidMarkers.addTo(a);const u=await ie("id_map_data");(await ie("id_map_data_helptext")).appendChild(await ie("map-spinner"));const h=(k=await te(u))==null?void 0:k.providerState;Ve(),h&&h==="GEOJSON"&&Xe();const c=()=>{te(u).then(v=>{(v==null?void 0:v.providerState)==="GEOJSON"&&(p.isUpdating=!0,ge(1,p),ve().then(w=>{ee(a,p,w)}))})},l=new et(1e3,c),f=new tt(document.body);Er(f),f.subscribeMutationObserver({childList:!0,subtree:!0},"span[id*='select2-id_stylesonlayer_set']",v=>{c()}),f.subscribeEventListener("input","textarea[id*='-feature_mapping']",v=>{l.trigger()});let m=0;const y=()=>{var b;const v=[];for(let x of document.querySelectorAll("tr[id*='stylesonlayer_set-']")){const N=(b=x.querySelector("textarea[id*='popup']"))==null?void 0:b.value;v.push(N)}const w=Ke(JSON.stringify(v));w!==m&&(m=w,c()),setTimeout(y,1e3)};y(),document.addEventListener("visibilitychange",async function(){if(document.visibilityState==="visible"){const v=await te(u);(v==null?void 0:v.providerState)==="GEOJSON"&&(p.isUpdating=!0,ge(1,p),ve().then(w=>{ee(a,p,w)}))}});const O=await ie("map-preview");async function d(){const v=await te(u),w=()=>{O.style.display="none"},b=()=>{O.style.display="block"};(v==null?void 0:v.providerState)==="GEOJSON"?(b(),p.isUpdating=!0,ge(1,p),Be(u).then(x=>ee(a,p,x))):w()}d(),u.addEventListener("change",d),Promise.all([ve(),Be(u)]).then(([v,w])=>{ee(a,p,w),p.isUpdating=!0,ee(a,p,v)})})()});
