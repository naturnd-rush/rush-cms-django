import{a as Wt,g as Vt}from"./graphql.js";import{l as K,c as zt,i as We,b as ht}from"./utils/math.js";import{w as Be,a as Me,T as Kt,e as ft}from"./utils/timing.js";import{D as jt}from"./utils/events.js";import{g as Qt,a as Zt}from"./_commonjsHelpers.js";var se="INUMBER",ke="IOP1",Ae="IOP2",Se="IOP3",he="IVAR",ye="IVARNAME",xe="IFUNCALL",qe="IFUNDEF",ne="IEXPR",et="IEXPREVAL",ge="IMEMBER",Fe="IENDSTATEMENT",Ee="IARRAY";function X(e,t){this.type=e,this.value=t??0}X.prototype.toString=function(){switch(this.type){case se:case ke:case Ae:case Se:case he:case ye:case Fe:return this.value;case xe:return"CALL "+this.value;case qe:return"DEF "+this.value;case Ee:return"ARRAY "+this.value;case ge:return"."+this.value;default:return"Invalid Instruction"}};function Ue(e){return new X(ke,e)}function ce(e){return new X(Ae,e)}function Lt(e){return new X(Se,e)}function Qe(e,t,r,n,i){for(var o=[],a=[],f,c,y,m,M=0;M<e.length;M++){var w=e[M],_=w.type;if(_===se||_===ye)Array.isArray(w.value)?o.push.apply(o,Qe(w.value.map(function(P){return new X(se,P)}).concat(new X(Ee,w.value.length)),t,r,n,i)):o.push(w);else if(_===he&&i.hasOwnProperty(w.value))w=new X(se,i[w.value]),o.push(w);else if(_===Ae&&o.length>1)c=o.pop(),f=o.pop(),m=r[w.value],w=new X(se,m(f.value,c.value)),o.push(w);else if(_===Se&&o.length>2)y=o.pop(),c=o.pop(),f=o.pop(),w.value==="?"?o.push(f.value?c.value:y.value):(m=n[w.value],w=new X(se,m(f.value,c.value,y.value)),o.push(w));else if(_===ke&&o.length>0)f=o.pop(),m=t[w.value],w=new X(se,m(f.value)),o.push(w);else if(_===ne){for(;o.length>0;)a.push(o.shift());a.push(new X(ne,Qe(w.value,t,r,n,i)))}else if(_===ge&&o.length>0)f=o.pop(),o.push(new X(se,f.value[w.value]));else{for(;o.length>0;)a.push(o.shift());a.push(w)}}for(;o.length>0;)a.push(o.shift());return a}function Ct(e,t,r){for(var n=[],i=0;i<e.length;i++){var o=e[i],a=o.type;if(a===he&&o.value===t)for(var f=0;f<r.tokens.length;f++){var c=r.tokens[f],y;c.type===ke?y=Ue(c.value):c.type===Ae?y=ce(c.value):c.type===Se?y=Lt(c.value):y=new X(c.type,c.value),n.push(y)}else a===ne?n.push(new X(ne,Ct(o.value,t,r))):n.push(o)}return n}function ve(e,t,r){var n=[],i,o,a,f,c,y;if(tt(e))return pe(e,r);for(var m=e.length,M=0;M<m;M++){var w=e[M],_=w.type;if(_===se||_===ye)n.push(w.value);else if(_===Ae)o=n.pop(),i=n.pop(),w.value==="and"?n.push(i?!!ve(o,t,r):!1):w.value==="or"?n.push(i?!0:!!ve(o,t,r)):w.value==="="?(f=t.binaryOps[w.value],n.push(f(i,ve(o,t,r),r))):(f=t.binaryOps[w.value],n.push(f(pe(i,r),pe(o,r))));else if(_===Se)a=n.pop(),o=n.pop(),i=n.pop(),w.value==="?"?n.push(ve(i?o:a,t,r)):(f=t.ternaryOps[w.value],n.push(f(pe(i,r),pe(o,r),pe(a,r))));else if(_===he)if(w.value in t.functions)n.push(t.functions[w.value]);else if(w.value in t.unaryOps&&t.parser.isOperatorEnabled(w.value))n.push(t.unaryOps[w.value]);else{var P=r[w.value];if(P!==void 0)n.push(P);else throw new Error("undefined variable: "+w.value)}else if(_===ke)i=n.pop(),f=t.unaryOps[w.value],n.push(f(pe(i,r)));else if(_===xe){for(y=w.value,c=[];y-- >0;)c.unshift(pe(n.pop(),r));if(f=n.pop(),f.apply&&f.call)n.push(f.apply(void 0,c));else throw new Error(f+" is not a function")}else if(_===qe)n.push(function(){for(var A=n.pop(),T=[],O=w.value;O-- >0;)T.unshift(n.pop());var u=n.pop(),p=function(){for(var s=Object.assign({},r),l=0,h=T.length;l<h;l++)s[T[l]]=arguments[l];return ve(A,t,s)};return Object.defineProperty(p,"name",{value:u,writable:!1}),r[u]=p,p}());else if(_===ne)n.push(er(w,t));else if(_===et)n.push(w);else if(_===ge)i=n.pop(),n.push(i[w.value]);else if(_===Fe)n.pop();else if(_===Ee){for(y=w.value,c=[];y-- >0;)c.unshift(n.pop());n.push(c)}else throw new Error("invalid Expression")}if(n.length>1)throw new Error("invalid Expression (parity)");return n[0]===0?0:pe(n[0],r)}function er(e,t,r){return tt(e)?e:{type:et,value:function(n){return ve(e.value,t,n)}}}function tt(e){return e&&e.type===et}function pe(e,t){return tt(e)?e.value(t):e}function rt(e,t){for(var r=[],n,i,o,a,f,c,y=0;y<e.length;y++){var m=e[y],M=m.type;if(M===se)typeof m.value=="number"&&m.value<0?r.push("("+m.value+")"):Array.isArray(m.value)?r.push("["+m.value.map(ct).join(", ")+"]"):r.push(ct(m.value));else if(M===Ae)i=r.pop(),n=r.pop(),a=m.value,t?a==="^"?r.push("Math.pow("+n+", "+i+")"):a==="and"?r.push("(!!"+n+" && !!"+i+")"):a==="or"?r.push("(!!"+n+" || !!"+i+")"):a==="||"?r.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+n+"),("+i+")))"):a==="=="?r.push("("+n+" === "+i+")"):a==="!="?r.push("("+n+" !== "+i+")"):a==="["?r.push(n+"[("+i+") | 0]"):r.push("("+n+" "+a+" "+i+")"):a==="["?r.push(n+"["+i+"]"):r.push("("+n+" "+a+" "+i+")");else if(M===Se)if(o=r.pop(),i=r.pop(),n=r.pop(),a=m.value,a==="?")r.push("("+n+" ? "+i+" : "+o+")");else throw new Error("invalid Expression");else if(M===he||M===ye)r.push(m.value);else if(M===ke)n=r.pop(),a=m.value,a==="-"||a==="+"?r.push("("+a+n+")"):t?a==="not"?r.push("(!"+n+")"):a==="!"?r.push("fac("+n+")"):r.push(a+"("+n+")"):a==="!"?r.push("("+n+"!)"):r.push("("+a+" "+n+")");else if(M===xe){for(c=m.value,f=[];c-- >0;)f.unshift(r.pop());a=r.pop(),r.push(a+"("+f.join(", ")+")")}else if(M===qe){for(i=r.pop(),c=m.value,f=[];c-- >0;)f.unshift(r.pop());n=r.pop(),t?r.push("("+n+" = function("+f.join(", ")+") { return "+i+" })"):r.push("("+n+"("+f.join(", ")+") = "+i+")")}else if(M===ge)n=r.pop(),r.push(n+"."+m.value);else if(M===Ee){for(c=m.value,f=[];c-- >0;)f.unshift(r.pop());r.push("["+f.join(", ")+"]")}else if(M===ne)r.push("("+rt(m.value,t)+")");else if(M!==Fe)throw new Error("invalid Expression")}return r.length>1&&(t?r=[r.join(",")]:r=[r.join(";")]),String(r[0])}function ct(e){return typeof e=="string"?JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):e}function we(e,t){for(var r=0;r<e.length;r++)if(e[r]===t)return!0;return!1}function nt(e,t,r){r=r||{};for(var n=!!r.withMembers,i=null,o=0;o<e.length;o++){var a=e[o];a.type===he||a.type===ye?!n&&!we(t,a.value)?t.push(a.value):(i!==null&&(we(t,i)||t.push(i)),i=a.value):a.type===ge&&n&&i!==null?i+="."+a.value:a.type===ne?nt(a.value,t,r):i!==null&&(we(t,i)||t.push(i),i=null)}i!==null&&!we(t,i)&&t.push(i)}function ue(e,t){this.tokens=e,this.parser=t,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.functions=t.functions}ue.prototype.simplify=function(e){return e=e||{},new ue(Qe(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,e),this.parser)};ue.prototype.substitute=function(e,t){return t instanceof ue||(t=this.parser.parse(String(t))),new ue(Ct(this.tokens,e,t),this.parser)};ue.prototype.evaluate=function(e){return e=e||{},ve(this.tokens,this,e)};ue.prototype.toString=function(){return rt(this.tokens,!1)};ue.prototype.symbols=function(e){e=e||{};var t=[];return nt(this.tokens,t,e),t};ue.prototype.variables=function(e){e=e||{};var t=[];nt(this.tokens,t,e);var r=this.functions;return t.filter(function(n){return!(n in r)})};ue.prototype.toJSFunction=function(e,t){var r=this,n=new Function(e,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+rt(this.simplify(t).tokens,!0)+"; }");return function(){return n.apply(r,arguments)}};var Ce="TEOF",G="TOP",Ge="TNUMBER",It="TSTRING",fe="TPAREN",Oe="TBRACKET",Je="TCOMMA",it="TNAME",st="TSEMICOLON";function Nt(e,t,r){this.type=e,this.value=t,this.index=r}Nt.prototype.toString=function(){return this.type+": "+this.value};function W(e,t){this.pos=0,this.current=null,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.consts=e.consts,this.expression=t,this.savedPosition=0,this.savedCurrent=null,this.options=e.options,this.parser=e}W.prototype.newToken=function(e,t,r){return new Nt(e,t,r??this.pos)};W.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};W.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};W.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(Ce,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};W.prototype.isString=function(){var e=!1,t=this.pos,r=this.expression.charAt(t);if(r==="'"||r==='"')for(var n=this.expression.indexOf(r,t+1);n>=0&&this.pos<this.expression.length;){if(this.pos=n+1,this.expression.charAt(n-1)!=="\\"){var i=this.expression.substring(t+1,n);this.current=this.newToken(It,this.unescape(i),t),e=!0;break}n=this.expression.indexOf(r,n+1)}return e};W.prototype.isParen=function(){var e=this.expression.charAt(this.pos);return e==="("||e===")"?(this.current=this.newToken(fe,e),this.pos++,!0):!1};W.prototype.isBracket=function(){var e=this.expression.charAt(this.pos);return(e==="["||e==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(Oe,e),this.pos++,!0):!1};W.prototype.isComma=function(){var e=this.expression.charAt(this.pos);return e===","?(this.current=this.newToken(Je,","),this.pos++,!0):!1};W.prototype.isSemicolon=function(){var e=this.expression.charAt(this.pos);return e===";"?(this.current=this.newToken(st,";"),this.pos++,!0):!1};W.prototype.isConst=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var r=this.expression.charAt(t);if(r.toUpperCase()===r.toLowerCase()&&(t===this.pos||r!=="_"&&r!=="."&&(r<"0"||r>"9")))break}if(t>e){var n=this.expression.substring(e,t);if(n in this.consts)return this.current=this.newToken(Ge,this.consts[n]),this.pos+=n.length,!0}return!1};W.prototype.isNamedOp=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var r=this.expression.charAt(t);if(r.toUpperCase()===r.toLowerCase()&&(t===this.pos||r!=="_"&&(r<"0"||r>"9")))break}if(t>e){var n=this.expression.substring(e,t);if(this.isOperatorEnabled(n)&&(n in this.binaryOps||n in this.unaryOps||n in this.ternaryOps))return this.current=this.newToken(G,n),this.pos+=n.length,!0}return!1};W.prototype.isName=function(){for(var e=this.pos,t=e,r=!1;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()){if(t===this.pos&&(n==="$"||n==="_")){n==="_"&&(r=!0);continue}else if(t===this.pos||!r||n!=="_"&&(n<"0"||n>"9"))break}else r=!0}if(r){var i=this.expression.substring(e,t);return this.current=this.newToken(it,i),this.pos+=i.length,!0}return!1};W.prototype.isWhitespace=function(){for(var e=!1,t=this.expression.charAt(this.pos);(t===" "||t==="	"||t===`
`||t==="\r")&&(e=!0,this.pos++,!(this.pos>=this.expression.length));)t=this.expression.charAt(this.pos);return e};var tr=/^[0-9a-f]{4}$/i;W.prototype.unescape=function(e){var t=e.indexOf("\\");if(t<0)return e;for(var r=e.substring(0,t);t>=0;){var n=e.charAt(++t);switch(n){case"'":r+="'";break;case'"':r+='"';break;case"\\":r+="\\";break;case"/":r+="/";break;case"b":r+="\b";break;case"f":r+="\f";break;case"n":r+=`
`;break;case"r":r+="\r";break;case"t":r+="	";break;case"u":var i=e.substring(t+1,t+5);tr.test(i)||this.parseError("Illegal escape sequence: \\u"+i),r+=String.fromCharCode(parseInt(i,16)),t+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+n+'"')}++t;var o=e.indexOf("\\",t);r+=e.substring(t,o<0?e.length:o),t=o}return r};W.prototype.isComment=function(){var e=this.expression.charAt(this.pos);return e==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};W.prototype.isRadixInteger=function(){var e=this.pos;if(e>=this.expression.length-2||this.expression.charAt(e)!=="0")return!1;++e;var t,r;if(this.expression.charAt(e)==="x")t=16,r=/^[0-9a-f]$/i,++e;else if(this.expression.charAt(e)==="b")t=2,r=/^[01]$/i,++e;else return!1;for(var n=!1,i=e;e<this.expression.length;){var o=this.expression.charAt(e);if(r.test(o))e++,n=!0;else break}return n&&(this.current=this.newToken(Ge,parseInt(this.expression.substring(i,e),t)),this.pos=e),n};W.prototype.isNumber=function(){for(var e=!1,t=this.pos,r=t,n=t,i=!1,o=!1,a;t<this.expression.length&&(a=this.expression.charAt(t),a>="0"&&a<="9"||!i&&a===".");)a==="."?i=!0:o=!0,t++,e=o;if(e&&(n=t),a==="e"||a==="E"){t++;for(var f=!0,c=!1;t<this.expression.length;){if(a=this.expression.charAt(t),f&&(a==="+"||a==="-"))f=!1;else if(a>="0"&&a<="9")c=!0,f=!1;else break;t++}c||(t=n)}return e?(this.current=this.newToken(Ge,parseFloat(this.expression.substring(r,t))),this.pos=t):this.pos=n,e};W.prototype.isOperator=function(){var e=this.pos,t=this.expression.charAt(this.pos);if(t==="+"||t==="-"||t==="*"||t==="/"||t==="%"||t==="^"||t==="?"||t===":"||t===".")this.current=this.newToken(G,t);else if(t==="∙"||t==="•")this.current=this.newToken(G,"*");else if(t===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(G,">="),this.pos++):this.current=this.newToken(G,">");else if(t==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(G,"<="),this.pos++):this.current=this.newToken(G,"<");else if(t==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(G,"||"),this.pos++;else return!1;else if(t==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(G,"=="),this.pos++):this.current=this.newToken(G,t);else if(t==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(G,"!="),this.pos++):this.current=this.newToken(G,t);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=e,!1)};W.prototype.isOperatorEnabled=function(e){return this.parser.isOperatorEnabled(e)};W.prototype.getCoordinates=function(){var e=0,t,r=-1;do e++,t=this.pos-r,r=this.expression.indexOf(`
`,r+1);while(r>=0&&r<this.pos);return{line:e,column:t}};W.prototype.parseError=function(e){var t=this.getCoordinates();throw new Error("parse error ["+t.line+":"+t.column+"]: "+e)};function J(e,t,r){this.parser=e,this.tokens=t,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=r.allowMemberAccess!==!1}J.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};J.prototype.tokenMatches=function(e,t){return typeof t>"u"?!0:Array.isArray(t)?we(t,e.value):typeof t=="function"?t(e):e.value===t};J.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};J.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};J.prototype.accept=function(e,t){return this.nextToken.type===e&&this.tokenMatches(this.nextToken,t)?(this.next(),!0):!1};J.prototype.expect=function(e,t){if(!this.accept(e,t)){var r=this.tokens.getCoordinates();throw new Error("parse error ["+r.line+":"+r.column+"]: Expected "+(t||e))}};J.prototype.parseAtom=function(e){var t=this.tokens.unaryOps;function r(i){return i.value in t}if(this.accept(it)||this.accept(G,r))e.push(new X(he,this.current.value));else if(this.accept(Ge))e.push(new X(se,this.current.value));else if(this.accept(It))e.push(new X(se,this.current.value));else if(this.accept(fe,"("))this.parseExpression(e),this.expect(fe,")");else if(this.accept(Oe,"["))if(this.accept(Oe,"]"))e.push(new X(Ee,0));else{var n=this.parseArrayList(e);e.push(new X(Ee,n))}else throw new Error("unexpected "+this.nextToken)};J.prototype.parseExpression=function(e){var t=[];this.parseUntilEndStatement(e,t)||(this.parseVariableAssignmentExpression(t),!this.parseUntilEndStatement(e,t)&&this.pushExpression(e,t))};J.prototype.pushExpression=function(e,t){for(var r=0,n=t.length;r<n;r++)e.push(t[r])};J.prototype.parseUntilEndStatement=function(e,t){return this.accept(st)?(this.nextToken&&this.nextToken.type!==Ce&&!(this.nextToken.type===fe&&this.nextToken.value===")")&&t.push(new X(Fe)),this.nextToken.type!==Ce&&this.parseExpression(t),e.push(new X(ne,t)),!0):!1};J.prototype.parseArrayList=function(e){for(var t=0;!this.accept(Oe,"]");)for(this.parseExpression(e),++t;this.accept(Je);)this.parseExpression(e),++t;return t};J.prototype.parseVariableAssignmentExpression=function(e){for(this.parseConditionalExpression(e);this.accept(G,"=");){var t=e.pop(),r=[],n=e.length-1;if(t.type===xe){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var i=0,o=t.value+1;i<o;i++){var a=n-i;e[a].type===he&&(e[a]=new X(ye,e[a].value))}this.parseVariableAssignmentExpression(r),e.push(new X(ne,r)),e.push(new X(qe,t.value));continue}if(t.type!==he&&t.type!==ge)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(r),e.push(new X(ye,t.value)),e.push(new X(ne,r)),e.push(ce("="))}};J.prototype.parseConditionalExpression=function(e){for(this.parseOrExpression(e);this.accept(G,"?");){var t=[],r=[];this.parseConditionalExpression(t),this.expect(G,":"),this.parseConditionalExpression(r),e.push(new X(ne,t)),e.push(new X(ne,r)),e.push(Lt("?"))}};J.prototype.parseOrExpression=function(e){for(this.parseAndExpression(e);this.accept(G,"or");){var t=[];this.parseAndExpression(t),e.push(new X(ne,t)),e.push(ce("or"))}};J.prototype.parseAndExpression=function(e){for(this.parseComparison(e);this.accept(G,"and");){var t=[];this.parseComparison(t),e.push(new X(ne,t)),e.push(ce("and"))}};var rr=["==","!=","<","<=",">=",">","in"];J.prototype.parseComparison=function(e){for(this.parseAddSub(e);this.accept(G,rr);){var t=this.current;this.parseAddSub(e),e.push(ce(t.value))}};var nr=["+","-","||"];J.prototype.parseAddSub=function(e){for(this.parseTerm(e);this.accept(G,nr);){var t=this.current;this.parseTerm(e),e.push(ce(t.value))}};var ir=["*","/","%"];J.prototype.parseTerm=function(e){for(this.parseFactor(e);this.accept(G,ir);){var t=this.current;this.parseFactor(e),e.push(ce(t.value))}};J.prototype.parseFactor=function(e){var t=this.tokens.unaryOps;function r(i){return i.value in t}if(this.save(),this.accept(G,r)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===fe&&this.nextToken.value==="("){this.restore(),this.parseExponential(e);return}else if(this.nextToken.type===st||this.nextToken.type===Je||this.nextToken.type===Ce||this.nextToken.type===fe&&this.nextToken.value===")"){this.restore(),this.parseAtom(e);return}}var n=this.current;this.parseFactor(e),e.push(Ue(n.value))}else this.parseExponential(e)};J.prototype.parseExponential=function(e){for(this.parsePostfixExpression(e);this.accept(G,"^");)this.parseFactor(e),e.push(ce("^"))};J.prototype.parsePostfixExpression=function(e){for(this.parseFunctionCall(e);this.accept(G,"!");)e.push(Ue("!"))};J.prototype.parseFunctionCall=function(e){var t=this.tokens.unaryOps;function r(o){return o.value in t}if(this.accept(G,r)){var n=this.current;this.parseAtom(e),e.push(Ue(n.value))}else for(this.parseMemberExpression(e);this.accept(fe,"(");)if(this.accept(fe,")"))e.push(new X(xe,0));else{var i=this.parseArgumentList(e);e.push(new X(xe,i))}};J.prototype.parseArgumentList=function(e){for(var t=0;!this.accept(fe,")");)for(this.parseExpression(e),++t;this.accept(Je);)this.parseExpression(e),++t;return t};J.prototype.parseMemberExpression=function(e){for(this.parseAtom(e);this.accept(G,".")||this.accept(Oe,"[");){var t=this.current;if(t.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(it),e.push(new X(ge,this.current.value))}else if(t.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(e),this.expect(Oe,"]"),e.push(ce("["))}else throw new Error("unexpected symbol: "+t.value)}};function sr(e,t){return Number(e)+Number(t)}function or(e,t){return e-t}function ar(e,t){return e*t}function ur(e,t){return e/t}function lr(e,t){return e%t}function pr(e,t){return Array.isArray(e)&&Array.isArray(t)?e.concat(t):""+e+t}function hr(e,t){return e===t}function fr(e,t){return e!==t}function cr(e,t){return e>t}function dr(e,t){return e<t}function vr(e,t){return e>=t}function yr(e,t){return e<=t}function gr(e,t){return!!(e&&t)}function mr(e,t){return!!(e||t)}function wr(e,t){return we(t,e)}function Mr(e){return(Math.exp(e)-Math.exp(-e))/2}function xr(e){return(Math.exp(e)+Math.exp(-e))/2}function Er(e){return e===1/0?1:e===-1/0?-1:(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function Or(e){return e===-1/0?e:Math.log(e+Math.sqrt(e*e+1))}function _r(e){return Math.log(e+Math.sqrt(e*e-1))}function kr(e){return Math.log((1+e)/(1-e))/2}function dt(e){return Math.log(e)*Math.LOG10E}function Ar(e){return-e}function Sr(e){return!e}function Pr(e){return e<0?Math.ceil(e):Math.floor(e)}function Tr(e){return Math.random()*(e||1)}function vt(e){return ot(e+1)}function br(e){return isFinite(e)&&e===Math.round(e)}var Lr=4.7421875,Ve=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function ot(e){var t,r;if(br(e)){if(e<=0)return isFinite(e)?1/0:NaN;if(e>171)return 1/0;for(var n=e-2,i=e-1;n>1;)i*=n,n--;return i===0&&(i=1),i}if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*ot(1-e));if(e>=171.35)return 1/0;if(e>85){var o=e*e,a=o*e,f=a*e,c=f*e;return Math.sqrt(2*Math.PI/e)*Math.pow(e/Math.E,e)*(1+1/(12*e)+1/(288*o)-139/(51840*a)-571/(2488320*f)+163879/(209018880*c)+5246819/(75246796800*c*e))}--e,r=Ve[0];for(var y=1;y<Ve.length;++y)r+=Ve[y]/(e+y);return t=e+Lr+.5,Math.sqrt(2*Math.PI)*Math.pow(t,e+.5)*Math.exp(-t)*r}function Cr(e){return Array.isArray(e)?e.length:String(e).length}function yt(){for(var e=0,t=0,r=0;r<arguments.length;r++){var n=Math.abs(arguments[r]),i;t<n?(i=t/n,e=e*i*i+1,t=n):n>0?(i=n/t,e+=i*i):e+=n}return t===1/0?1/0:t*Math.sqrt(e)}function gt(e,t,r){return e?t:r}function Ir(e,t){return typeof t>"u"||+t==0?Math.round(e):(e=+e,t=-+t,isNaN(e)||!(typeof t=="number"&&t%1===0)?NaN:(e=e.toString().split("e"),e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]+t:t))))}function Nr(e,t,r){return r&&(r[e]=t),t}function Br(e,t){return e[t|0]}function Xr(e){return arguments.length===1&&Array.isArray(e)?Math.max.apply(Math,e):Math.max.apply(Math,arguments)}function Rr(e){return arguments.length===1&&Array.isArray(e)?Math.min.apply(Math,e):Math.min.apply(Math,arguments)}function Yr(e,t){if(typeof e!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(t))throw new Error("Second argument to map is not an array");return t.map(function(r,n){return e(r,n)})}function Dr(e,t,r){if(typeof e!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(r))throw new Error("Second argument to fold is not an array");return r.reduce(function(n,i,o){return e(n,i,o)},t)}function qr(e,t){if(typeof e!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(t))throw new Error("Second argument to filter is not an array");return t.filter(function(r,n){return e(r,n)})}function Fr(e,t){if(!(Array.isArray(t)||typeof t=="string"))throw new Error("Second argument to indexOf is not a string or array");return t.indexOf(e)}function Ur(e,t){if(!Array.isArray(t))throw new Error("Second argument to join is not an array");return t.join(e)}function Gr(e){return(e>0)-(e<0)||+e}var mt=1/3;function Jr(e){return e<0?-Math.pow(-e,mt):Math.pow(e,mt)}function $r(e){return Math.exp(e)-1}function Hr(e){return Math.log(1+e)}function Wr(e){return Math.log(e)/Math.LN2}function me(e){this.options=e||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||Mr,cosh:Math.cosh||xr,tanh:Math.tanh||Er,asinh:Math.asinh||Or,acosh:Math.acosh||_r,atanh:Math.atanh||kr,sqrt:Math.sqrt,cbrt:Math.cbrt||Jr,log:Math.log,log2:Math.log2||Wr,ln:Math.log,lg:Math.log10||dt,log10:Math.log10||dt,expm1:Math.expm1||$r,log1p:Math.log1p||Hr,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||Pr,"-":Ar,"+":Number,exp:Math.exp,not:Sr,length:Cr,"!":vt,sign:Math.sign||Gr},this.binaryOps={"+":sr,"-":or,"*":ar,"/":ur,"%":lr,"^":Math.pow,"||":pr,"==":hr,"!=":fr,">":cr,"<":dr,">=":vr,"<=":yr,and:gr,or:mr,in:wr,"=":Nr,"[":Br},this.ternaryOps={"?":gt},this.functions={random:Tr,fac:vt,min:Rr,max:Xr,hypot:Math.hypot||yt,pyt:Math.hypot||yt,pow:Math.pow,atan2:Math.atan2,if:gt,gamma:ot,roundTo:Ir,map:Yr,fold:Dr,filter:qr,indexOf:Fr,join:Ur},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}me.prototype.parse=function(e){var t=[],r=new J(this,new W(this,e),{allowMemberAccess:this.options.allowMemberAccess});return r.parseExpression(t),r.expect(Ce,"EOF"),new ue(t,this)};me.prototype.evaluate=function(e,t){return this.parse(e).evaluate(t)};var Bt=new me;me.parse=function(e){return Bt.parse(e)};me.evaluate=function(e,t){return Bt.parse(e).evaluate(t)};var wt={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function Vr(e){return wt.hasOwnProperty(e)?wt[e]:e}me.prototype.isOperatorEnabled=function(e){var t=Vr(e),r=this.options.operators||{};return!(t in r)||!!r[t]};/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var zr=Object.prototype.toString,Pe=Array.isArray||function(t){return zr.call(t)==="[object Array]"};function at(e){return typeof e=="function"}function Kr(e){return Pe(e)?"array":typeof e}function ze(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Mt(e,t){return e!=null&&typeof e=="object"&&t in e}function jr(e,t){return e!=null&&typeof e!="object"&&e.hasOwnProperty&&e.hasOwnProperty(t)}var Qr=RegExp.prototype.test;function Zr(e,t){return Qr.call(e,t)}var en=/\S/;function tn(e){return!Zr(en,e)}var rn={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function nn(e){return String(e).replace(/[&<>"'`=\/]/g,function(r){return rn[r]})}var sn=/\s*/,on=/\s+/,xt=/\s*=/,an=/\s*\}/,un=/#|\^|\/|>|\{|&|=|!/;function ln(e,t){if(!e)return[];var r=!1,n=[],i=[],o=[],a=!1,f=!1,c="",y=0;function m(){if(a&&!f)for(;o.length;)delete i[o.pop()];else o=[];a=!1,f=!1}var M,w,_;function P(v){if(typeof v=="string"&&(v=v.split(on,2)),!Pe(v)||v.length!==2)throw new Error("Invalid tags: "+v);M=new RegExp(ze(v[0])+"\\s*"),w=new RegExp("\\s*"+ze(v[1])),_=new RegExp("\\s*"+ze("}"+v[1]))}P(t||ie.tags);for(var A=new Ne(e),T,O,u,p,s,l;!A.eos();){if(T=A.pos,u=A.scanUntil(M),u)for(var h=0,d=u.length;h<d;++h)p=u.charAt(h),tn(p)?(o.push(i.length),c+=p):(f=!0,r=!0,c+=" "),i.push(["text",p,T,T+1]),T+=1,p===`
`&&(m(),c="",y=0,r=!1);if(!A.scan(M))break;if(a=!0,O=A.scan(un)||"name",A.scan(sn),O==="="?(u=A.scanUntil(xt),A.scan(xt),A.scanUntil(w)):O==="{"?(u=A.scanUntil(_),A.scan(an),A.scanUntil(w),O="&"):u=A.scanUntil(w),!A.scan(w))throw new Error("Unclosed tag at "+A.pos);if(O==">"?s=[O,u,T,A.pos,c,y,r]:s=[O,u,T,A.pos],y++,i.push(s),O==="#"||O==="^")n.push(s);else if(O==="/"){if(l=n.pop(),!l)throw new Error('Unopened section "'+u+'" at '+T);if(l[1]!==u)throw new Error('Unclosed section "'+l[1]+'" at '+T)}else O==="name"||O==="{"||O==="&"?f=!0:O==="="&&P(u)}if(m(),l=n.pop(),l)throw new Error('Unclosed section "'+l[1]+'" at '+A.pos);return hn(pn(i))}function pn(e){for(var t=[],r,n,i=0,o=e.length;i<o;++i)r=e[i],r&&(r[0]==="text"&&n&&n[0]==="text"?(n[1]+=r[1],n[3]=r[3]):(t.push(r),n=r));return t}function hn(e){for(var t=[],r=t,n=[],i,o,a=0,f=e.length;a<f;++a)switch(i=e[a],i[0]){case"#":case"^":r.push(i),n.push(i),r=i[4]=[];break;case"/":o=n.pop(),o[5]=i[2],r=n.length>0?n[n.length-1][4]:t;break;default:r.push(i)}return t}function Ne(e){this.string=e,this.tail=e,this.pos=0}Ne.prototype.eos=function(){return this.tail===""};Ne.prototype.scan=function(t){var r=this.tail.match(t);if(!r||r.index!==0)return"";var n=r[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n};Ne.prototype.scanUntil=function(t){var r=this.tail.search(t),n;switch(r){case-1:n=this.tail,this.tail="";break;case 0:n="";break;default:n=this.tail.substring(0,r),this.tail=this.tail.substring(r)}return this.pos+=n.length,n};function _e(e,t){this.view=e,this.cache={".":this.view},this.parent=t}_e.prototype.push=function(t){return new _e(t,this)};_e.prototype.lookup=function(t){var r=this.cache,n;if(r.hasOwnProperty(t))n=r[t];else{for(var i=this,o,a,f,c=!1;i;){if(t.indexOf(".")>0)for(o=i.view,a=t.split("."),f=0;o!=null&&f<a.length;)f===a.length-1&&(c=Mt(o,a[f])||jr(o,a[f])),o=o[a[f++]];else o=i.view[t],c=Mt(i.view,t);if(c){n=o;break}i=i.parent}r[t]=n}return at(n)&&(n=n.call(this.view)),n};function j(){this.templateCache={_cache:{},set:function(t,r){this._cache[t]=r},get:function(t){return this._cache[t]},clear:function(){this._cache={}}}}j.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};j.prototype.parse=function(t,r){var n=this.templateCache,i=t+":"+(r||ie.tags).join(":"),o=typeof n<"u",a=o?n.get(i):void 0;return a==null&&(a=ln(t,r),o&&n.set(i,a)),a};j.prototype.render=function(t,r,n,i){var o=this.getConfigTags(i),a=this.parse(t,o),f=r instanceof _e?r:new _e(r,void 0);return this.renderTokens(a,f,n,t,i)};j.prototype.renderTokens=function(t,r,n,i,o){for(var a="",f,c,y,m=0,M=t.length;m<M;++m)y=void 0,f=t[m],c=f[0],c==="#"?y=this.renderSection(f,r,n,i,o):c==="^"?y=this.renderInverted(f,r,n,i,o):c===">"?y=this.renderPartial(f,r,n,o):c==="&"?y=this.unescapedValue(f,r):c==="name"?y=this.escapedValue(f,r,o):c==="text"&&(y=this.rawValue(f)),y!==void 0&&(a+=y);return a};j.prototype.renderSection=function(t,r,n,i,o){var a=this,f="",c=r.lookup(t[1]);function y(w){return a.render(w,r,n,o)}if(c){if(Pe(c))for(var m=0,M=c.length;m<M;++m)f+=this.renderTokens(t[4],r.push(c[m]),n,i,o);else if(typeof c=="object"||typeof c=="string"||typeof c=="number")f+=this.renderTokens(t[4],r.push(c),n,i,o);else if(at(c)){if(typeof i!="string")throw new Error("Cannot use higher-order sections without the original template");c=c.call(r.view,i.slice(t[3],t[5]),y),c!=null&&(f+=c)}else f+=this.renderTokens(t[4],r,n,i,o);return f}};j.prototype.renderInverted=function(t,r,n,i,o){var a=r.lookup(t[1]);if(!a||Pe(a)&&a.length===0)return this.renderTokens(t[4],r,n,i,o)};j.prototype.indentPartial=function(t,r,n){for(var i=r.replace(/[^ \t]/g,""),o=t.split(`
`),a=0;a<o.length;a++)o[a].length&&(a>0||!n)&&(o[a]=i+o[a]);return o.join(`
`)};j.prototype.renderPartial=function(t,r,n,i){if(n){var o=this.getConfigTags(i),a=at(n)?n(t[1]):n[t[1]];if(a!=null){var f=t[6],c=t[5],y=t[4],m=a;c==0&&y&&(m=this.indentPartial(a,y,f));var M=this.parse(m,o);return this.renderTokens(M,r,n,m,i)}}};j.prototype.unescapedValue=function(t,r){var n=r.lookup(t[1]);if(n!=null)return n};j.prototype.escapedValue=function(t,r,n){var i=this.getConfigEscape(n)||ie.escape,o=r.lookup(t[1]);if(o!=null)return typeof o=="number"&&i===ie.escape?String(o):i(o)};j.prototype.rawValue=function(t){return t[1]};j.prototype.getConfigTags=function(t){return Pe(t)?t:t&&typeof t=="object"?t.tags:void 0};j.prototype.getConfigEscape=function(t){if(t&&typeof t=="object"&&!Pe(t))return t.escape};var ie={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){Ie.templateCache=e},get templateCache(){return Ie.templateCache}},Ie=new j;ie.clearCache=function(){return Ie.clearCache()};ie.parse=function(t,r){return Ie.parse(t,r)};ie.render=function(t,r,n,i){if(typeof t!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+Kr(t)+'" was given as the first argument for mustache#render(template, view, partials)');return Ie.render(t,r,n,i)};ie.escape=nn;ie.Scanner=Ne;ie.Context=_e;ie.Writer=j;function Xt(e,t,r={}){const n={type:"Feature"};return(r.id===0||r.id)&&(n.id=r.id),r.bbox&&(n.bbox=r.bbox),n.properties=t||{},n.geometry=e,n}function Ze(e,t,r={}){if(!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!Et(e[0])||!Et(e[1]))throw new Error("coordinates must contain numbers");return Xt({type:"Point",coordinates:e},t,r)}function fn(e,t,r={}){for(const i of e){if(i.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(i[i.length-1].length!==i[0].length)throw new Error("First and last Position are not equivalent.");for(let o=0;o<i[i.length-1].length;o++)if(i[i.length-1][o]!==i[0][o])throw new Error("First and last Position are not equivalent.")}return Xt({type:"Polygon",coordinates:e},t,r)}function Et(e){return!isNaN(e)&&e!==null&&!Array.isArray(e)}function $e(e,t,r){if(e!==null)for(var n,i,o,a,f,c,y,m=0,M=0,w,_=e.type,P=_==="FeatureCollection",A=_==="Feature",T=P?e.features.length:1,O=0;O<T;O++){y=P?e.features[O].geometry:A?e.geometry:e,w=y?y.type==="GeometryCollection":!1,f=w?y.geometries.length:1;for(var u=0;u<f;u++){var p=0,s=0;if(a=w?y.geometries[u]:y,a!==null){c=a.coordinates;var l=a.type;switch(m=r&&(l==="Polygon"||l==="MultiPolygon")?1:0,l){case null:break;case"Point":if(t(c,M,O,p,s)===!1)return!1;M++,p++;break;case"LineString":case"MultiPoint":for(n=0;n<c.length;n++){if(t(c[n],M,O,p,s)===!1)return!1;M++,l==="MultiPoint"&&p++}l==="LineString"&&p++;break;case"Polygon":case"MultiLineString":for(n=0;n<c.length;n++){for(i=0;i<c[n].length-m;i++){if(t(c[n][i],M,O,p,s)===!1)return!1;M++}l==="MultiLineString"&&p++,l==="Polygon"&&s++}l==="Polygon"&&p++;break;case"MultiPolygon":for(n=0;n<c.length;n++){for(s=0,i=0;i<c[n].length;i++){for(o=0;o<c[n][i].length-m;o++){if(t(c[n][i][o],M,O,p,s)===!1)return!1;M++}s++}p++}break;case"GeometryCollection":for(n=0;n<a.geometries.length;n++)if($e(a.geometries[n],t,r)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}var Xe={exports:{}},Re={exports:{}},cn=Re.exports,Ot;function dn(){return Ot||(Ot=1,function(e,t){(function(r,n){e.exports=n()})(cn,function(){function r(u,p,s,l,h){(function d(v,g,x,E,k){for(;E>x;){if(E-x>600){var C=E-x+1,B=g-x+1,z=Math.log(C),I=.5*Math.exp(2*z/3),R=.5*Math.sqrt(z*I*(C-I)/C)*(B-C/2<0?-1:1),Y=Math.max(x,Math.floor(g-B*I/C+R)),U=Math.min(E,Math.floor(g+(C-B)*I/C+R));d(v,g,Y,U,k)}var S=v[g],b=x,L=E;for(n(v,x,g),k(v[E],S)>0&&n(v,x,E);b<L;){for(n(v,b,L),b++,L--;k(v[b],S)<0;)b++;for(;k(v[L],S)>0;)L--}k(v[x],S)===0?n(v,x,L):n(v,++L,E),L<=g&&(x=L+1),g<=L&&(E=L-1)}})(u,p,s||0,l||u.length-1,h||i)}function n(u,p,s){var l=u[p];u[p]=u[s],u[s]=l}function i(u,p){return u<p?-1:u>p?1:0}var o=function(u){u===void 0&&(u=9),this._maxEntries=Math.max(4,u),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function a(u,p,s){if(!s)return p.indexOf(u);for(var l=0;l<p.length;l++)if(s(u,p[l]))return l;return-1}function f(u,p){c(u,0,u.children.length,p,u)}function c(u,p,s,l,h){h||(h=T(null)),h.minX=1/0,h.minY=1/0,h.maxX=-1/0,h.maxY=-1/0;for(var d=p;d<s;d++){var v=u.children[d];y(h,u.leaf?l(v):v)}return h}function y(u,p){return u.minX=Math.min(u.minX,p.minX),u.minY=Math.min(u.minY,p.minY),u.maxX=Math.max(u.maxX,p.maxX),u.maxY=Math.max(u.maxY,p.maxY),u}function m(u,p){return u.minX-p.minX}function M(u,p){return u.minY-p.minY}function w(u){return(u.maxX-u.minX)*(u.maxY-u.minY)}function _(u){return u.maxX-u.minX+(u.maxY-u.minY)}function P(u,p){return u.minX<=p.minX&&u.minY<=p.minY&&p.maxX<=u.maxX&&p.maxY<=u.maxY}function A(u,p){return p.minX<=u.maxX&&p.minY<=u.maxY&&p.maxX>=u.minX&&p.maxY>=u.minY}function T(u){return{children:u,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function O(u,p,s,l,h){for(var d=[p,s];d.length;)if(!((s=d.pop())-(p=d.pop())<=l)){var v=p+Math.ceil((s-p)/l/2)*l;r(u,v,p,s,h),d.push(p,v,v,s)}}return o.prototype.all=function(){return this._all(this.data,[])},o.prototype.search=function(u){var p=this.data,s=[];if(!A(u,p))return s;for(var l=this.toBBox,h=[];p;){for(var d=0;d<p.children.length;d++){var v=p.children[d],g=p.leaf?l(v):v;A(u,g)&&(p.leaf?s.push(v):P(u,g)?this._all(v,s):h.push(v))}p=h.pop()}return s},o.prototype.collides=function(u){var p=this.data;if(!A(u,p))return!1;for(var s=[];p;){for(var l=0;l<p.children.length;l++){var h=p.children[l],d=p.leaf?this.toBBox(h):h;if(A(u,d)){if(p.leaf||P(u,d))return!0;s.push(h)}}p=s.pop()}return!1},o.prototype.load=function(u){if(!u||!u.length)return this;if(u.length<this._minEntries){for(var p=0;p<u.length;p++)this.insert(u[p]);return this}var s=this._build(u.slice(),0,u.length-1,0);if(this.data.children.length)if(this.data.height===s.height)this._splitRoot(this.data,s);else{if(this.data.height<s.height){var l=this.data;this.data=s,s=l}this._insert(s,this.data.height-s.height-1,!0)}else this.data=s;return this},o.prototype.insert=function(u){return u&&this._insert(u,this.data.height-1),this},o.prototype.clear=function(){return this.data=T([]),this},o.prototype.remove=function(u,p){if(!u)return this;for(var s,l,h,d=this.data,v=this.toBBox(u),g=[],x=[];d||g.length;){if(d||(d=g.pop(),l=g[g.length-1],s=x.pop(),h=!0),d.leaf){var E=a(u,d.children,p);if(E!==-1)return d.children.splice(E,1),g.push(d),this._condense(g),this}h||d.leaf||!P(d,v)?l?(s++,d=l.children[s],h=!1):d=null:(g.push(d),x.push(s),s=0,l=d,d=d.children[0])}return this},o.prototype.toBBox=function(u){return u},o.prototype.compareMinX=function(u,p){return u.minX-p.minX},o.prototype.compareMinY=function(u,p){return u.minY-p.minY},o.prototype.toJSON=function(){return this.data},o.prototype.fromJSON=function(u){return this.data=u,this},o.prototype._all=function(u,p){for(var s=[];u;)u.leaf?p.push.apply(p,u.children):s.push.apply(s,u.children),u=s.pop();return p},o.prototype._build=function(u,p,s,l){var h,d=s-p+1,v=this._maxEntries;if(d<=v)return f(h=T(u.slice(p,s+1)),this.toBBox),h;l||(l=Math.ceil(Math.log(d)/Math.log(v)),v=Math.ceil(d/Math.pow(v,l-1))),(h=T([])).leaf=!1,h.height=l;var g=Math.ceil(d/v),x=g*Math.ceil(Math.sqrt(v));O(u,p,s,x,this.compareMinX);for(var E=p;E<=s;E+=x){var k=Math.min(E+x-1,s);O(u,E,k,g,this.compareMinY);for(var C=E;C<=k;C+=g){var B=Math.min(C+g-1,k);h.children.push(this._build(u,C,B,l-1))}}return f(h,this.toBBox),h},o.prototype._chooseSubtree=function(u,p,s,l){for(;l.push(p),!p.leaf&&l.length-1!==s;){for(var h=1/0,d=1/0,v=void 0,g=0;g<p.children.length;g++){var x=p.children[g],E=w(x),k=(C=u,B=x,(Math.max(B.maxX,C.maxX)-Math.min(B.minX,C.minX))*(Math.max(B.maxY,C.maxY)-Math.min(B.minY,C.minY))-E);k<d?(d=k,h=E<h?E:h,v=x):k===d&&E<h&&(h=E,v=x)}p=v||p.children[0]}var C,B;return p},o.prototype._insert=function(u,p,s){var l=s?u:this.toBBox(u),h=[],d=this._chooseSubtree(l,this.data,p,h);for(d.children.push(u),y(d,l);p>=0&&h[p].children.length>this._maxEntries;)this._split(h,p),p--;this._adjustParentBBoxes(l,h,p)},o.prototype._split=function(u,p){var s=u[p],l=s.children.length,h=this._minEntries;this._chooseSplitAxis(s,h,l);var d=this._chooseSplitIndex(s,h,l),v=T(s.children.splice(d,s.children.length-d));v.height=s.height,v.leaf=s.leaf,f(s,this.toBBox),f(v,this.toBBox),p?u[p-1].children.push(v):this._splitRoot(s,v)},o.prototype._splitRoot=function(u,p){this.data=T([u,p]),this.data.height=u.height+1,this.data.leaf=!1,f(this.data,this.toBBox)},o.prototype._chooseSplitIndex=function(u,p,s){for(var l,h,d,v,g,x,E,k=1/0,C=1/0,B=p;B<=s-p;B++){var z=c(u,0,B,this.toBBox),I=c(u,B,s,this.toBBox),R=(h=z,d=I,v=void 0,g=void 0,x=void 0,E=void 0,v=Math.max(h.minX,d.minX),g=Math.max(h.minY,d.minY),x=Math.min(h.maxX,d.maxX),E=Math.min(h.maxY,d.maxY),Math.max(0,x-v)*Math.max(0,E-g)),Y=w(z)+w(I);R<k?(k=R,l=B,C=Y<C?Y:C):R===k&&Y<C&&(C=Y,l=B)}return l||s-p},o.prototype._chooseSplitAxis=function(u,p,s){var l=u.leaf?this.compareMinX:m,h=u.leaf?this.compareMinY:M;this._allDistMargin(u,p,s,l)<this._allDistMargin(u,p,s,h)&&u.children.sort(l)},o.prototype._allDistMargin=function(u,p,s,l){u.children.sort(l);for(var h=this.toBBox,d=c(u,0,p,h),v=c(u,s-p,s,h),g=_(d)+_(v),x=p;x<s-p;x++){var E=u.children[x];y(d,u.leaf?h(E):E),g+=_(d)}for(var k=s-p-1;k>=p;k--){var C=u.children[k];y(v,u.leaf?h(C):C),g+=_(v)}return g},o.prototype._adjustParentBBoxes=function(u,p,s){for(var l=s;l>=0;l--)y(p[l],u)},o.prototype._condense=function(u){for(var p=u.length-1,s=void 0;p>=0;p--)u[p].children.length===0?p>0?(s=u[p-1].children).splice(s.indexOf(u[p]),1):this.clear():f(u[p],this.toBBox)},o})}(Re)),Re.exports}class vn{constructor(t=[],r=yn){if(this.data=t,this.length=this.data.length,this.compare=r,this.length>0)for(let n=(this.length>>1)-1;n>=0;n--)this._down(n)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const t=this.data[0],r=this.data.pop();return this.length--,this.length>0&&(this.data[0]=r,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:r,compare:n}=this,i=r[t];for(;t>0;){const o=t-1>>1,a=r[o];if(n(i,a)>=0)break;r[t]=a,t=o}r[t]=i}_down(t){const{data:r,compare:n}=this,i=this.length>>1,o=r[t];for(;t<i;){let a=(t<<1)+1,f=r[a];const c=a+1;if(c<this.length&&n(r[c],f)<0&&(a=c,f=r[c]),n(f,o)>=0)break;r[t]=f,t=a}r[t]=o}}function yn(e,t){return e<t?-1:e>t?1:0}const gn=Object.freeze(Object.defineProperty({__proto__:null,default:vn},Symbol.toStringTag,{value:"Module"})),mn=Qt(gn);var be={exports:{}},Ke,_t;function wn(){return _t||(_t=1,Ke=function(t,r,n,i){var o=t[0],a=t[1],f=!1;n===void 0&&(n=0),i===void 0&&(i=r.length);for(var c=(i-n)/2,y=0,m=c-1;y<c;m=y++){var M=r[n+y*2+0],w=r[n+y*2+1],_=r[n+m*2+0],P=r[n+m*2+1],A=w>a!=P>a&&o<(_-M)*(a-w)/(P-w)+M;A&&(f=!f)}return f}),Ke}var je,kt;function Mn(){return kt||(kt=1,je=function(t,r,n,i){var o=t[0],a=t[1],f=!1;n===void 0&&(n=0),i===void 0&&(i=r.length);for(var c=i-n,y=0,m=c-1;y<c;m=y++){var M=r[y+n][0],w=r[y+n][1],_=r[m+n][0],P=r[m+n][1],A=w>a!=P>a&&o<(_-M)*(a-w)/(P-w)+M;A&&(f=!f)}return f}),je}var At;function xn(){if(At)return be.exports;At=1;var e=wn(),t=Mn();return be.exports=function(n,i,o,a){return i.length>0&&Array.isArray(i[0])?t(n,i,o,a):e(n,i,o,a)},be.exports.nested=t,be.exports.flat=e,be.exports}var Le={exports:{}},En=Le.exports,St;function On(){return St||(St=1,function(e,t){(function(r,n){n(t)})(En,function(r){const i=33306690738754706e-32;function o(A,T,O,u,p){let s,l,h,d,v=T[0],g=u[0],x=0,E=0;g>v==g>-v?(s=v,v=T[++x]):(s=g,g=u[++E]);let k=0;if(x<A&&E<O)for(g>v==g>-v?(h=s-((l=v+s)-v),v=T[++x]):(h=s-((l=g+s)-g),g=u[++E]),s=l,h!==0&&(p[k++]=h);x<A&&E<O;)g>v==g>-v?(h=s-((l=s+v)-(d=l-s))+(v-d),v=T[++x]):(h=s-((l=s+g)-(d=l-s))+(g-d),g=u[++E]),s=l,h!==0&&(p[k++]=h);for(;x<A;)h=s-((l=s+v)-(d=l-s))+(v-d),v=T[++x],s=l,h!==0&&(p[k++]=h);for(;E<O;)h=s-((l=s+g)-(d=l-s))+(g-d),g=u[++E],s=l,h!==0&&(p[k++]=h);return s===0&&k!==0||(p[k++]=s),k}function a(A){return new Float64Array(A)}const f=33306690738754716e-32,c=22204460492503146e-32,y=11093356479670487e-47,m=a(4),M=a(8),w=a(12),_=a(16),P=a(4);r.orient2d=function(A,T,O,u,p,s){const l=(T-s)*(O-p),h=(A-p)*(u-s),d=l-h;if(l===0||h===0||l>0!=h>0)return d;const v=Math.abs(l+h);return Math.abs(d)>=f*v?d:-function(g,x,E,k,C,B,z){let I,R,Y,U,S,b,L,$,F,D,N,q,V,H,Q,Z,le,ee;const te=g-C,re=E-C,oe=x-B,ae=k-B;S=(Q=($=te-(L=(b=134217729*te)-(b-te)))*(D=ae-(F=(b=134217729*ae)-(b-ae)))-((H=te*ae)-L*F-$*F-L*D))-(N=Q-(le=($=oe-(L=(b=134217729*oe)-(b-oe)))*(D=re-(F=(b=134217729*re)-(b-re)))-((Z=oe*re)-L*F-$*F-L*D))),m[0]=Q-(N+S)+(S-le),S=(V=H-((q=H+N)-(S=q-H))+(N-S))-(N=V-Z),m[1]=V-(N+S)+(S-Z),S=(ee=q+N)-q,m[2]=q-(ee-S)+(N-S),m[3]=ee;let de=function(Ht,lt){let pt=lt[0];for(let He=1;He<Ht;He++)pt+=lt[He];return pt}(4,m),Te=c*z;if(de>=Te||-de>=Te||(I=g-(te+(S=g-te))+(S-C),Y=E-(re+(S=E-re))+(S-C),R=x-(oe+(S=x-oe))+(S-B),U=k-(ae+(S=k-ae))+(S-B),I===0&&R===0&&Y===0&&U===0)||(Te=y*z+i*Math.abs(de),(de+=te*U+ae*I-(oe*Y+re*R))>=Te||-de>=Te))return de;S=(Q=($=I-(L=(b=134217729*I)-(b-I)))*(D=ae-(F=(b=134217729*ae)-(b-ae)))-((H=I*ae)-L*F-$*F-L*D))-(N=Q-(le=($=R-(L=(b=134217729*R)-(b-R)))*(D=re-(F=(b=134217729*re)-(b-re)))-((Z=R*re)-L*F-$*F-L*D))),P[0]=Q-(N+S)+(S-le),S=(V=H-((q=H+N)-(S=q-H))+(N-S))-(N=V-Z),P[1]=V-(N+S)+(S-Z),S=(ee=q+N)-q,P[2]=q-(ee-S)+(N-S),P[3]=ee;const Gt=o(4,m,4,P,M);S=(Q=($=te-(L=(b=134217729*te)-(b-te)))*(D=U-(F=(b=134217729*U)-(b-U)))-((H=te*U)-L*F-$*F-L*D))-(N=Q-(le=($=oe-(L=(b=134217729*oe)-(b-oe)))*(D=Y-(F=(b=134217729*Y)-(b-Y)))-((Z=oe*Y)-L*F-$*F-L*D))),P[0]=Q-(N+S)+(S-le),S=(V=H-((q=H+N)-(S=q-H))+(N-S))-(N=V-Z),P[1]=V-(N+S)+(S-Z),S=(ee=q+N)-q,P[2]=q-(ee-S)+(N-S),P[3]=ee;const Jt=o(Gt,M,4,P,w);S=(Q=($=I-(L=(b=134217729*I)-(b-I)))*(D=U-(F=(b=134217729*U)-(b-U)))-((H=I*U)-L*F-$*F-L*D))-(N=Q-(le=($=R-(L=(b=134217729*R)-(b-R)))*(D=Y-(F=(b=134217729*Y)-(b-Y)))-((Z=R*Y)-L*F-$*F-L*D))),P[0]=Q-(N+S)+(S-le),S=(V=H-((q=H+N)-(S=q-H))+(N-S))-(N=V-Z),P[1]=V-(N+S)+(S-Z),S=(ee=q+N)-q,P[2]=q-(ee-S)+(N-S),P[3]=ee;const $t=o(Jt,w,4,P,_);return _[$t-1]}(A,T,O,u,p,s,v)},r.orient2dfast=function(A,T,O,u,p,s){return(T-s)*(O-p)-(A-p)*(u-s)},Object.defineProperty(r,"__esModule",{value:!0})})}(Le,Le.exports)),Le.exports}var Pt;function _n(){if(Pt)return Xe.exports;Pt=1;var e=dn(),t=mn,r=xn(),n=On().orient2d;t.default&&(t=t.default),Xe.exports=i,Xe.exports.default=i;function i(s,l,h){l=Math.max(0,l===void 0?2:l),h=h||0;var d=_(s),v=new e(16);v.toBBox=function(L){return{minX:L[0],minY:L[1],maxX:L[0],maxY:L[1]}},v.compareMinX=function(L,$){return L[0]-$[0]},v.compareMinY=function(L,$){return L[1]-$[1]},v.load(s);for(var g=[],x=0,E;x<d.length;x++){var k=d[x];v.remove(k),E=P(k,E),g.push(E)}var C=new e(16);for(x=0;x<g.length;x++)C.insert(w(g[x]));for(var B=l*l,z=h*h;g.length;){var I=g.shift(),R=I.p,Y=I.next.p,U=A(R,Y);if(!(U<z)){var S=U/B;k=o(v,I.prev.p,R,Y,I.next.next.p,S,C),k&&Math.min(A(k,R),A(k,Y))<=S&&(g.push(I),g.push(P(k,I)),v.remove(k),C.remove(I),C.insert(w(I)),C.insert(w(I.next)))}}I=E;var b=[];do b.push(I.p),I=I.next;while(I!==E);return b.push(I.p),b}function o(s,l,h,d,v,g,x){for(var E=new t([],a),k=s.data;k;){for(var C=0;C<k.children.length;C++){var B=k.children[C],z=k.leaf?T(B,h,d):f(h,d,B);z>g||E.push({node:B,dist:z})}for(;E.length&&!E.peek().node.children;){var I=E.pop(),R=I.node,Y=T(R,l,h),U=T(R,d,v);if(I.dist<Y&&I.dist<U&&y(h,R,x)&&y(d,R,x))return R}k=E.pop(),k&&(k=k.node)}return null}function a(s,l){return s.dist-l.dist}function f(s,l,h){if(c(s,h)||c(l,h))return 0;var d=O(s[0],s[1],l[0],l[1],h.minX,h.minY,h.maxX,h.minY);if(d===0)return 0;var v=O(s[0],s[1],l[0],l[1],h.minX,h.minY,h.minX,h.maxY);if(v===0)return 0;var g=O(s[0],s[1],l[0],l[1],h.maxX,h.minY,h.maxX,h.maxY);if(g===0)return 0;var x=O(s[0],s[1],l[0],l[1],h.minX,h.maxY,h.maxX,h.maxY);return x===0?0:Math.min(d,v,g,x)}function c(s,l){return s[0]>=l.minX&&s[0]<=l.maxX&&s[1]>=l.minY&&s[1]<=l.maxY}function y(s,l,h){for(var d=Math.min(s[0],l[0]),v=Math.min(s[1],l[1]),g=Math.max(s[0],l[0]),x=Math.max(s[1],l[1]),E=h.search({minX:d,minY:v,maxX:g,maxY:x}),k=0;k<E.length;k++)if(M(E[k].p,E[k].next.p,s,l))return!1;return!0}function m(s,l,h){return n(s[0],s[1],l[0],l[1],h[0],h[1])}function M(s,l,h,d){return s!==d&&l!==h&&m(s,l,h)>0!=m(s,l,d)>0&&m(h,d,s)>0!=m(h,d,l)>0}function w(s){var l=s.p,h=s.next.p;return s.minX=Math.min(l[0],h[0]),s.minY=Math.min(l[1],h[1]),s.maxX=Math.max(l[0],h[0]),s.maxY=Math.max(l[1],h[1]),s}function _(s){for(var l=s[0],h=s[0],d=s[0],v=s[0],g=0;g<s.length;g++){var x=s[g];x[0]<l[0]&&(l=x),x[0]>d[0]&&(d=x),x[1]<h[1]&&(h=x),x[1]>v[1]&&(v=x)}var E=[l,h,d,v],k=E.slice();for(g=0;g<s.length;g++)r(s[g],E)||k.push(s[g]);return p(k)}function P(s,l){var h={p:s,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return l?(h.next=l.next,h.prev=l,l.next.prev=h,l.next=h):(h.prev=h,h.next=h),h}function A(s,l){var h=s[0]-l[0],d=s[1]-l[1];return h*h+d*d}function T(s,l,h){var d=l[0],v=l[1],g=h[0]-d,x=h[1]-v;if(g!==0||x!==0){var E=((s[0]-d)*g+(s[1]-v)*x)/(g*g+x*x);E>1?(d=h[0],v=h[1]):E>0&&(d+=g*E,v+=x*E)}return g=s[0]-d,x=s[1]-v,g*g+x*x}function O(s,l,h,d,v,g,x,E){var k=h-s,C=d-l,B=x-v,z=E-g,I=s-v,R=l-g,Y=k*k+C*C,U=k*B+C*z,S=B*B+z*z,b=k*I+C*R,L=B*I+z*R,$=Y*S-U*U,F,D,N,q,V=$,H=$;$===0?(D=0,V=1,q=L,H=S):(D=U*L-S*b,q=Y*L-U*b,D<0?(D=0,q=L,H=S):D>V&&(D=V,q=L+U,H=S)),q<0?(q=0,-b<0?D=0:-b>Y?D=V:(D=-b,V=Y)):q>H&&(q=H,-b+U<0?D=0:-b+U>Y?D=V:(D=-b+U,V=Y)),F=D===0?0:D/V,N=q===0?0:q/H;var Q=(1-F)*s+F*h,Z=(1-F)*l+F*d,le=(1-N)*v+N*x,ee=(1-N)*g+N*E,te=le-Q,re=ee-Z;return te*te+re*re}function u(s,l){return s[0]===l[0]?s[1]-l[1]:s[0]-l[0]}function p(s){s.sort(u);for(var l=[],h=0;h<s.length;h++){for(;l.length>=2&&m(l[l.length-2],l[l.length-1],s[h])<=0;)l.pop();l.push(s[h])}for(var d=[],v=s.length-1;v>=0;v--){for(;d.length>=2&&m(d[d.length-2],d[d.length-1],s[v])<=0;)d.pop();d.push(s[v])}return d.pop(),l.pop(),l.concat(d)}return Xe.exports}var kn=_n();const An=Zt(kn);function Sn(e,t={}){t.concavity=t.concavity||1/0;const r=[];if($e(e,i=>{r.push([i[0],i[1]])}),!r.length)return null;const n=An(r,t.concavity);return n.length>3?fn([n]):null}function Tt(e,t={}){let r=0,n=0,i=0;return $e(e,function(o){r+=o[0],n+=o[1],i++},!0),Ze([r/i,n/i],t.properties)}function Pn(e){if(!e)throw new Error("coord is required");if(!Array.isArray(e)){if(e.type==="Feature"&&e.geometry!==null&&e.geometry.type==="Point")return[...e.geometry.coordinates];if(e.type==="Point")return[...e.coordinates]}if(Array.isArray(e)&&e.length>=2&&!Array.isArray(e[0])&&!Array.isArray(e[1]))return[...e];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Tn(e,t){return e.type==="FeatureCollection"?"FeatureCollection":e.type==="GeometryCollection"?"GeometryCollection":e.type==="Feature"&&e.geometry!==null?e.geometry.type:e.type}function Rt(e,t={}){switch(Tn(e)){case"Point":return Ze(Pn(e),t.properties);case"Polygon":var r=[];$e(e,function(s){r.push(s)});var n=Tt(e,{properties:t.properties}),i=n.geometry.coordinates,o=0,a=0,f=0,c,y,m,M,w,_,P,A,T=r.map(function(s){return[s[0]-i[0],s[1]-i[1]]});for(c=0;c<r.length-1;c++)y=T[c],M=y[0],_=y[1],m=T[c+1],w=m[0],P=m[1],A=M*P-w*_,f+=A,o+=(M+w)*A,a+=(_+P)*A;if(f===0)return n;var O=f*.5,u=1/(6*O);return Ze([i[0]+u*o,i[1]+u*a],t.properties);default:var p=Sn(e);return p?Rt(p,{properties:t.properties}):Tt(e,{properties:t.properties})}}var bn=Rt;async function Yt(){var t,r,n,i,o,a,f,c,y,m,M,w;const e=[];for(let _ of document.querySelectorAll("[id^='stylesonlayer_set-']:not([id$='-group'])")){const P=(t=_.querySelector("select[id*='-style']"))==null?void 0:t.value,A=(r=_.querySelector("textarea[id*='feature_mapping']"))==null?void 0:r.value,T=(n=_.querySelector("textarea[id*='popup']"))==null?void 0:n.value,O=(i=_.querySelector("input[id*='-draw_popup']"))==null?void 0:i.checked,u=(o=_.querySelector("input[id*='-draw_tooltip']"))==null?void 0:o.checked,p=(a=_.querySelector("textarea[id*='label']"))==null?void 0:a.value,s=(f=_.querySelector("input[id*='offset_x']"))==null?void 0:f.value,l=(c=_.querySelector("input[id*='offset_y']"))==null?void 0:c.value,h=(y=_.querySelector("input[id*='opacity']"))==null?void 0:y.value,d=(m=_.querySelector("select[id*='direction']"))==null?void 0:m.value,v=(M=_.querySelector("input[id*='permanent']"))==null?void 0:M.checked,g=(w=_.querySelector("input[id*='sticky']"))==null?void 0:w.checked;if(!(P&&A))continue;const x=await Vt(P);if(x!==null&&A!==void 0&&T!==void 0&&O!==void 0&&u!==void 0&&p!==void 0&&s!==void 0&&l!==void 0&&h!==void 0&&d!==void 0&&v!==void 0&&g!==void 0){const E={label:p,offsetX:Number.parseFloat(s),offsetY:Number.parseFloat(l),opacity:Number.parseFloat(h),direction:d,permanent:v,sticky:g},k={style:x,feature_mapping:A,inlineRow:_,drawPopup:O,popupTemplate:T,drawTooltip:u,tooltip:E};e.push(k)}else{const E={label:p,offsetX:s!==void 0?Number.parseFloat(s):Number.NaN,offsetY:l!==void 0?Number.parseFloat(l):Number.NaN,opacity:h!==void 0?Number.parseFloat(h):Number.NaN,direction:d,permanent:v,sticky:g};console.warn("One or more expected values in a StyleOnLayer inline is missing: ",{style:x,feature_mapping:A,inlineRow:_,drawPopup:O,popupTemplate:T,drawTooltip:u,tooltip:E})}}return{type:"Style",newStylesOnLayers:e}}async function De(e){let t=null;for(let r of e.childNodes)r instanceof HTMLOptionElement&&r.selected&&(t=r.value);return t===null||t===""?null:await Wt(t)}async function bt(e){const t={type:"MapData",newGeoJsonData:null},r=await De(e);if(r===null)return t;if(r.geojson===null)return t;const n=JSON.parse(r.geojson);return n.features===null||n.features===void 0?t:{type:"MapData",newGeoJsonData:n}}function ut(e,t){const r=new me;let n=[];for(let i of t){const o=i.inlineRow.querySelector("td[class*='feature_mapping']"),a=o==null?void 0:o.querySelector("div[id*='errors']");try{r.parse(i.feature_mapping).evaluate(zt(e.properties))===!0&&(n.push({styleOnLayer:i,popupTemplate:i.popupTemplate}),a&&o&&o.removeChild(a))}catch(f){if(a&&o&&o.removeChild(a),o&&!(o!=null&&o.querySelector("div[id*='errors']"))){const c=document.createElement("div");c.textContent=String(f),c.id="errors",c.style="color:rgb(255, 0, 0);",o.insertBefore(c,o.children[0])}}}return n}function Ln(){return{fill:!0,fillColor:"#4B3EFF",fillOpacity:.3,stroke:!0,weight:1,opacity:1,color:"#4B3EFF",dashArray:"1 10",dashOffset:"0",lineCap:"round",lineJoin:"round"}}function Cn(e){return r=>{if(e.stylesOnLayer.length==0&&!e.isUpdating)return Ln();let n=ut(r,e.stylesOnLayer),i=!1,o,a,f=!1,c,y,m,M="",w,_="round",P="round";for(let T of n){const O=T.styleOnLayer.style;O.drawFill===!0&&(i=!0),O.drawStroke===!0&&(f=!0),o=We(o,O.fillOpacity),c=We(c,O.strokeOpacity),m=We(m,O.strokeWeight),a===void 0?a=O.fillColor:a=ht(a,O.fillColor,.5),y===void 0?y=O.strokeColor:y=ht(y,O.strokeColor,.5),O.strokeDashArray!==null&&(M=O.strokeDashArray),O.strokeDashOffset!==null&&(w=O.strokeDashOffset),P=O.strokeLineJoin,_=O.strokeLineCap}const A={fill:i,fillColor:a,fillOpacity:o,stroke:f,weight:m,opacity:c,color:y,dashArray:M,dashOffset:w,lineCap:_,lineJoin:P};return r.properties.__style=A,A}}function Dt(e,t){const r=t.markerSize,n=Math.sqrt(Math.pow(r/2,2)+Math.pow(r/2,2));return{html:`
            <div>
                <div style="
                    width: ${n*2}px;
                    height: ${n*2}px;
                    background-color: ${t.markerBackgroundColor};
                    opacity: ${t.markerBackgroundOpacity};
                    border-radius: 50%;
                    display: flex;
                    position: absolute;
                "></div>
                <img 
                    src="${e+t.markerIcon}"
                    style="
                        width: ${r}px; 
                        height: ${r}px;
                        opacity: ${t.markerIconOpacity};
                        position: relative;
                        top: ${n-r/2}px;
                        left: ${n-r/2}px;
                    "
                />
            </div>
        `,className:"",iconSize:[n*2,n*2],iconAnchor:[n,n]}}function In(e,t){return(n,i)=>{let o=null;const a=ut(n,t.stylesOnLayer);for(let c of a){const y=c.styleOnLayer.style;if(y.drawMarker===!0){o=y;break}}if(o===null)return new K.Marker(i,{opacity:0});const f=Dt(e,o);return n.properties.__pointDivIconStyleProps=f,K.marker(i,{icon:new K.DivIcon(f)})}}async function qt(){const e=Me(document.body,"input[name='_save']"),t=Me(document.body,"input[name='_addanother']"),r=Me(document.body,"input[name='_continue']");e.disabled=!0,t.disabled=!0,r.disabled=!0;const n=document.getElementById("map-preview"),i=document.getElementById("map-spinner");n!==null&&i!==null?(n.classList.add("blur"),i.classList.remove("hidden")):console.error("Couldn't find map-preview and map-spinner in the DOM!")}function Ft(){const e=Me(document.body,"input[name='_save']"),t=Me(document.body,"input[name='_addanother']"),r=Me(document.body,"input[name='_continue']");e.disabled=!1,t.disabled=!1,r.disabled=!1;const n=document.getElementById("map-preview"),i=document.getElementById("map-spinner");n!==null&&i!==null?(n.classList.remove("blur"),i.classList.add("hidden")):console.error("Couldn't find map-preview and map-spinner in the DOM!")}function Ut(e,t){setTimeout(()=>{t.isUpdating&&qt()},e*1e3)}function Nn(e,t){if(t===null)return{__hasPopup:!1,__popupHTML:null,__popupOptions:null};let r=!1;return t=t.replace(/<img(.*?)>/g,o=>(r=!0,o.replace("<img",'<img style="max-width:250px; height:auto;"'))),{__hasPopup:!0,__popupHTML:ie.render(t,e.properties),__popupOptions:{maxWidth:250,minWidth:r?250:0}}}function Bn(e){let t=null;for(let r of e)r.popupTemplate!==null&&r.popupTemplate!==""&&r.styleOnLayer.drawPopup===!0&&(t=r.popupTemplate);return t}function Ye(e,t,r){if(t.currentLayer!==null&&e.removeLayer(t.currentLayer),t.centroidMarkers.clearLayers(),t.centroidTooltips.clearLayers(),r.type==="MapData"){const f=r.newGeoJsonData;f===null?t.currentLayer=null:(t.currentLayer=K.geoJSON(f),e.fitBounds(t.currentLayer.getBounds()))}else r.type==="Style"&&(t.stylesOnLayer=r.newStylesOnLayers);if(t.currentLayer===null)return;const n=ft("injected-media-url").innerHTML,i=t.stylesOnLayer.filter(f=>f.style.drawMarker==!0).length>0,o=K.geoJSON(t.currentLayer.toGeoJSON(),{style:Cn(t),pointToLayer:In(n,t),onEachFeature:(f,c)=>{const y=ut(f,t.stylesOnLayer),m=Bn(y),M=Nn(f,m);M.__hasPopup===!0&&M.__popupHTML!==null&&M.__popupOptions!==null&&(c.bindPopup(M.__popupHTML,M.__popupOptions),f.properties={...f.properties,...M});const[w,_]=bn(f).geometry.coordinates;let P=null;for(let T of y)if(T.styleOnLayer.drawTooltip===!0){P=T.styleOnLayer.tooltip;break}if(P!==null){const T=ie.render(P.label,f.properties),O={offset:new K.Point(P.offsetX,P.offsetY),opacity:P.opacity,direction:P.direction,permanent:P.permanent,sticky:P.sticky,className:"leaflet-label"},u=K.tooltip(O);u.setLatLng([_,w]),u.setContent(T),u.addTo(t.centroidTooltips),f.properties={...f.properties,__hasTooltip:!0,__tooltipLat:_,__tooltipLng:w,__tooltipHTML:T,__tooltipOptions:O}}else f.properties={...f.properties,__hasTooltip:!1};if((f.geometry.type==="MultiPolygon"||f.geometry.type=="Polygon")&&i){const T=y.filter(O=>O.styleOnLayer.style.drawMarker==!0);if(T.length>0){const O=T[0].styleOnLayer.style;((p,s)=>{const l=Dt(n,O),h={type:"Feature",geometry:{type:"Point",coordinates:[s,p]},properties:{__pointDivIconStyleProps:l,...M}},d=K.geoJSON(h,{pointToLayer:(v,g)=>K.marker(g,{icon:new K.DivIcon(l)})}).getLayers()[0];M.__hasPopup===!0&&M.__popupHTML!==null&&M.__popupOptions!==null&&d.bindPopup(M.__popupHTML,M.__popupOptions),d.addTo(t.centroidMarkers)})(_,w)}}}});t.currentLayer=o,o.addTo(e),Ft(),t.isUpdating=!1;const a=ft("id_serialized_leaflet_json");a.value=Xn(t)}function Xn(e){var r;let t=new K.LayerGroup(e.centroidMarkers.getLayers());return(r=e.currentLayer)==null||r.addTo(t),JSON.stringify({featureCollection:t.toGeoJSON()})}const Rn=e=>{const t=(a,f)=>Array.from(a.querySelectorAll('div[class*="form-row"]')).filter(m=>{var M;return(M=m.querySelector("label"))==null?void 0:M.textContent.includes(f)}),r=(a,f,c)=>{e.subscribeEventListener("input",a,y=>{if(y.target!==null&&y.target instanceof HTMLInputElement){const m=y.target.closest("div[id*='stylesonlayer_set-']");if(m===null||!(m instanceof HTMLElement))throw new Error("Could not find 'draw_tooltip' form-field parent row!");const M=t(m,f);c(y.target.closest("div[class*='form-row']"),M,y.target.checked)}}),document.querySelectorAll(a).forEach(y=>y.dispatchEvent(new Event("input",{bubbles:!0})))},n="#FFFFFF",i="#E2DBC4",o="#f6f6f6";r("input[id*='-draw_tooltip']","Tooltip",(a,f,c)=>{for(let y of f)c===!0?(y.style.display="block",y.style.setProperty("background-color",o),a==null||a.style.setProperty("background-color",i)):(y.style.display="none",y.style.setProperty("background-color",n),a==null||a.style.setProperty("background-color",n))}),r("input[id*='-draw_popup']","Popup",(a,f,c)=>{for(let y of f)c===!0?(y.style.display="block",y.style.setProperty("background-color",o),a==null||a.style.setProperty("background-color",i)):(y.style.display="none",y.style.setProperty("background-color",n),a==null||a.style.setProperty("background-color",n))})},Yn=(e,t,r,n)=>{const i=()=>{De(r).then(m=>{(m==null?void 0:m.providerState)==="GEOJSON"&&(n.isUpdating=!0,Ut(1,n),Yt().then(M=>{Ye(t,n,M)}))})},o=new Kt(1e3,i);e.subscribeEventListener("input","textarea[id*='-feature_mapping']",m=>o.trigger()),e.subscribeEventListener("input","input[id*='-offset_x']",m=>o.trigger()),e.subscribeEventListener("input","input[id*='-offset_y']",m=>o.trigger()),e.subscribeEventListener("input","input[id*='-opacity']",m=>o.trigger());let a="",f="";const c=["textarea[id*='popup']","textarea[id*='label']"],y=()=>{f="";for(let m of c)for(let M of document.querySelectorAll(m))M instanceof HTMLTextAreaElement&&(f+=M.value);f!==a&&(i(),a=f),setTimeout(y,1e3)};y(),e.subscribeMutationObserver({childList:!0,subtree:!0},"span[id*='select2-id_stylesonlayer_set']",i),e.subscribeEventListener("input","input[id*='-draw_popup']",i),e.subscribeEventListener("input","input[id*='-draw_tooltip']",i),e.subscribeEventListener("change","select[id*='-direction']",i),e.subscribeEventListener("input","input[id*='-permanent']",i),e.subscribeEventListener("input","input[id*='-sticky']",i),document.addEventListener("visibilitychange",async function(){document.visibilityState==="visible"&&i()})};document.addEventListener("DOMContentLoaded",()=>{(async()=>{var P;const e={minZoom:0,maxZoom:22,updateWhenIdle:!0,zIndex:0,attribution:'© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>'},t="rushadmin",r="clw2m6f9b018001obfxcc747g",n="pk.eyJ1IjoicnVzaGFkbWluIiwiYSI6ImNsdzJtYmRydzBuNDIyam5yZ2pwMG16cnUifQ.SkSSdHcrPq4u8HSitBvJcg",i="https://api.mapbox.com/styles/v1/",o=`${t}/${r}/tiles/256/{z}/{x}/{y}@2x`,a=`?access_token=${n}`;let f=K.map("map-preview").setView([0,0],2);K.tileLayer(i+o+a,e).addTo(f);let c={isUpdating:!0,stylesOnLayer:[],currentLayer:null,centroidMarkers:new K.LayerGroup,centroidTooltips:new K.LayerGroup};c.centroidMarkers.addTo(f),c.centroidTooltips.addTo(f);const y=await Be("id_map_data");(await Be("id_map_data_helptext")).appendChild(await Be("map-spinner"));const m=(P=await De(y))==null?void 0:P.providerState;Ft(),m&&m==="GEOJSON"&&qt();const M=new jt(document.body);Yn(M,f,y,c),Rn(M);const w=await Be("map-preview");async function _(){const A=await De(y),T=()=>{w.style.display="none"},O=()=>{w.style.display="block"};(A==null?void 0:A.providerState)==="GEOJSON"?(O(),c.isUpdating=!0,Ut(1,c),bt(y).then(u=>Ye(f,c,u))):T()}_(),y.addEventListener("change",_),Promise.all([Yt(),bt(y)]).then(([A,T])=>{Ye(f,c,T),c.isUpdating=!0,Ye(f,c,A)})})()});
